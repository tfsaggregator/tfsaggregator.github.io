<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="History field #  The History field always appends a new message, the property allows to edit the message until work item is saved.
For example, this code causes an infinite loop (eventually stopped by rateLimiting feature).
self.History = &#34;Hello&#34;; Aggregator is triggered again and again for the same work item.
Some background information #  The TFS aggregator only updates a work item if any field has changed by its calculations."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="History field"><meta property="og:description" content="History field #  The History field always appends a new message, the property allows to edit the message until work item is saved.
For example, this code causes an infinite loop (eventually stopped by rateLimiting feature).
self.History = &#34;Hello&#34;; Aggregator is triggered again and again for the same work item.
Some background information #  The TFS aggregator only updates a work item if any field has changed by its calculations."><meta property="og:type" content="article"><meta property="og:url" content="https://tfsaggregator.github.io/docs/v2/using/field-history/"><meta property="article:modified_time" content="2022-08-10T20:05:17+02:00"><title>History field | Aggregator</title><link rel=manifest href=https://tfsaggregator.github.io/manifest.json><link rel=icon href=https://tfsaggregator.github.io/favicon.png type=image/x-icon><link rel=stylesheet href=https://tfsaggregator.github.io/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI="><script defer src=https://tfsaggregator.github.io/en.search.min.b2b260425a57b8f86604d5563d29a733c0f67fabe2b119e06b273500421bd117.js integrity="sha256-srJgQlpXuPhmBNVWPSmnM8D2f6visRngayc1AEIb0Rc="></script></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=https://tfsaggregator.github.io/><span>Aggregator</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://tfsaggregator.github.io/docs/v3/>Aggregator 3 (CLI)</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/>Setup</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azdo-authn/>Azure DevOps Personal Access Token</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azure/>Azure CLI Setup</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/docker/>Docker configuration</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/production/>Production on Azure</a><ul></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/>CLI Commands</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/commands/common-options/>Common options</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/authentication-commands/>Authentication commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/instance-commands/>Instance commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/rule-commands/>Rule commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/map-commands/>Mapping commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/info-commands/>Informational commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/command-examples/>Examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/>Rules</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/rules/directives/>Directives</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/workitem/>WorkItem event objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/common-rule-objects/>Common objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-basic/>Basic examples</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-advanced/>Advanced examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/>Design</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/design/caveat/>Caveats</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/parallelism/>Parallelism</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/api/>REST API</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/troubleshoot/>Troubleshoot</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/>Contribute</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/pipelines/>Pipelines</a></li></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/>TFS Aggregator v2</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/intro/ class=collapsed>Introduction</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/ class=collapsed>Users' Guide</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/using/writing-rules/writing-rules/>Writing Rules and Policies</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/policy-syntax/>Configuration XML syntax</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/scripting/>Scripting the Rules</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/objects-reference/>Objects Reference</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/using/objects-reference/self-object/>self Object</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/objects-reference/field-object/>Field Object</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/objects-reference/store-object/>store Object</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/objects-reference/logger-object/>logger Object</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/objects-reference/library-objects/>Library Objects</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/examples/>Examples of Policies</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/using/examples/accumulate-to-grand-parent/>Accumulate to grand-parent example</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/examples/auto-create-children/>Auto-Create Children example</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/examples/auto-open-auto-close/>Auto-Open and Auto-Close example</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/examples/log-time-synch/>Remaining Work and Completed Work synchronization for Task WI</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/examples/rollup/>Rollup examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/scripting-tricks-n-tips/scripting-tricks-n-tips/>Tricks & Tips</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/scripting-pitfalls/>Common Pitfalls</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/field-history/ class=active>History field</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/upgrade-from-v1/>Upgrading from v1</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/ class=collapsed>Administrator Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/ class=collapsed>Contributing</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/changelog/>Changelog</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=https://tfsaggregator.github.io/svg/menu.svg class=book-icon alt=Menu></label>
<strong>History field</strong>
<label for=toc-control><img src=https://tfsaggregator.github.io/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#history-field>History field</a><ul><li><a href=#some-background-information>Some background information</a></li><li><a href=#marker-technique>Marker Technique</a></li></ul></li></ul></nav></aside></header><article class=markdown><h2 id=history-field>History field
<a class=anchor href=#history-field>#</a></h2><p>The History field always appends a new message, the property allows to edit the message until work item is saved.</p><p>For example, this code causes an infinite loop (eventually stopped by <strong>rateLimiting</strong> feature).</p><pre><code>self.History = &quot;Hello&quot;;
</code></pre><p>Aggregator is triggered again and again for the same work item.</p><h3 id=some-background-information>Some background information
<a class=anchor href=#some-background-information>#</a></h3><p>The TFS aggregator only updates a work item if any field has changed by its calculations. If the calculations yield the same value as last time, the work item is considered clean and no new revision is created.</p><p>The History field is a strange kind of field, it always being empty, unless you&rsquo;ve added a new value to it while processing. Therefore, setting the history field to anything other than <code>string.Empty</code> or <code>null</code> will cause a workitem to be saved.</p><p>Whenever a workitem is saved, the TFS Aggregator triggers again. This is by design and allows for cascading rules. It&rsquo;s also why we&rsquo;ve recently added a rate limiter. Normally the same set of rules triggers again, all calculations yield the same value and that breaks the loop that would otherwise be created.</p><p><em>Except</em> when a rule always sets the value of the history field. As it was <strong>empty</strong> when we started calculating and is now <strong>not empty</strong> it will cause the work item to be saved.</p><p>To prevent this from happening there are a few things you can do:</p><ol><li>Before setting the History field, check the <code>.IsDirty</code> property of the work item. If it&rsquo;s not dirty, don&rsquo;t add anything to the history.</li><li>Iterate through the revisions of the work item to ensure that you&rsquo;re not adding the same comment you added last time. This causes additional database and network traffic, and is therefore less desirable.</li><li>Don&rsquo;t store your data in the History Field, instead stick it in a custom field or use any of the pre-existing fields to store your data in. (Don&rsquo;t append to an existing field as that would cause the same behavior)</li><li>If you&rsquo;re not using Impersonation, check whether the &ldquo;<em>Changed By</em>&rdquo; field is set to the service account and assume that the changes are not made by a human, therefore skipping the changes to the history field.</li></ol><h3 id=marker-technique>Marker Technique
<a class=anchor href=#marker-technique>#</a></h3><p>This technique corresponds to suggestion #2, i.e. using a Marker to distinguish between user and rule changes.</p><pre><code>const string HistoryMarker = &quot;===&quot;;

var lastRevision = self.LastRevision;
var history = lastRevision.Fields[&quot;History&quot;];
string lastValue = (string) history.Value;

logger.Log(&quot;At revision {0} History value is '{1}'&quot;, lastRevision.Index, lastValue);

if (!lastValue.StartsWith(HistoryMarker))
{
  self.History = HistoryMarker + &quot;Hello&quot;;
  logger.Log(&quot;Marker added&quot;);
}
</code></pre></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/commit/a60075892725bb6571714924424b856bb5566830 title="Last modified by Jesse Houwing | August 10, 2022" target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/calendar.svg class=book-icon alt=Calendar>
<span>August 10, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/edit/master/content//docs/v2/using/field-history.md target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#history-field>History field</a><ul><li><a href=#some-background-information>Some background information</a></li><li><a href=#marker-technique>Marker Technique</a></li></ul></li></ul></nav></aside></main></body></html>