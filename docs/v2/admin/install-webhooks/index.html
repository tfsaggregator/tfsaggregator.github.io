<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This information does not apply to theServer Plugin version.
 Installing TFS Aggregator Web Service is a six step process:
 Grant access to VSTS/TFS Deploy TfsAggregator web application Configure TFS Aggregator Define the policy Setup logging (optional) Setup the Web Hooks in TFS/VSTS  Grant access to VSTS/TFS #  There are three possible options to grant access. In most cases you will have to change the configuration later using the values collected in this step."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Installing the Web Service"><meta property="og:description" content="This information does not apply to theServer Plugin version.
 Installing TFS Aggregator Web Service is a six step process:
 Grant access to VSTS/TFS Deploy TfsAggregator web application Configure TFS Aggregator Define the policy Setup logging (optional) Setup the Web Hooks in TFS/VSTS  Grant access to VSTS/TFS #  There are three possible options to grant access. In most cases you will have to change the configuration later using the values collected in this step."><meta property="og:type" content="article"><meta property="og:url" content="https://tfsaggregator.github.io/docs/v2/admin/install-webhooks/"><meta property="article:modified_time" content="2020-06-27T11:47:08+01:00"><title>Installing the Web Service | Aggregator</title><link rel=manifest href=https://tfsaggregator.github.io/manifest.json><link rel=icon href=https://tfsaggregator.github.io/favicon.png type=image/x-icon><link rel=stylesheet href=https://tfsaggregator.github.io/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI="><script defer src=https://tfsaggregator.github.io/en.search.min.79b29c0410859deaad07cf24bf423bc7931d6cf8248cc9fdff5893c24939190b.js integrity="sha256-ebKcBBCFneqtB88kv0I7x5MdbPgkjMn9/1iTwkk5GQs="></script></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=https://tfsaggregator.github.io/><span>Aggregator</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://tfsaggregator.github.io/docs/v3/>Aggregator CLI</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/>Setup</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/production/>Production</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/>Commands</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/commands/command-examples/>Examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/>Rules</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-basic/>Basic examples</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-advanced/>Advanced examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/>Design</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/design/parallelism/>Parallelism</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/>Contribute</a><ul></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/>TFS Aggregator v2</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/intro/ class=collapsed>Introduction</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/ class=collapsed>Users' Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/ class=collapsed>Administrator Guide</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/admin/install/>Installing the Server Plugin</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/install-webhooks/ class=active>Installing the Web Service</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/console-app/>Using the console to test Policies</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/logging/>Logging</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/troubleshooting/>Troubleshooting</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/support/>Support</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/security/>Security</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/ class=collapsed>Contributing</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/changelog/>Changelog</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=https://tfsaggregator.github.io/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Installing the Web Service</strong>
<label for=toc-control><img src=https://tfsaggregator.github.io/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#grant-access-to-vststfs>Grant access to VSTS/TFS</a><ul><li><a href=#1-using-a-personal-access-token>1. Using a Personal Access Token</a></li><li><a href=#2-tfs-only-account-permissions>2. [TFS only] Account permissions</a></li><li><a href=#3-tfs-only-explicit-credentials>3. [TFS only] Explicit credentials</a></li></ul></li><li><a href=#deploy-tfsaggregator-web-application>Deploy TfsAggregator web application</a><ul><li><a href=#1-tfs-only-install-on-iis>1. [TFS only] Install on IIS</a></li><li><a href=#2-deploy-to-azure>2. Deploy to Azure</a></li></ul></li><li><a href=#configure-tfs-aggregator>Configure TFS Aggregator</a><ul><li><a href=#add-users-to-webconfig-file>Add users to <code>web.config</code> file</a></li><li><a href=#configure-the-policy-mapping>Configure the policy mapping</a></li></ul></li><li><a href=#define-the-policy>Define the policy</a><ul><li><a href=#specify-authentication-in-the-policy>Specify Authentication in the policy</a></li></ul></li><li><a href=#setup-logging-optional>Setup logging (optional)</a></li><li><a href=#setup-the-web-hooks-in-tfsvsts>Setup the Web Hooks in TFS/VSTS</a><ul><li><a href=#using-powershell>Using Powershell</a></li><li><a href=#manual-configuration>Manual configuration</a></li></ul></li><li><a href=#final-testing>Final testing</a></li></ul></nav></aside></header><article class=markdown><blockquote><p>This information does <strong>not</strong> apply to theServer Plugin version.</p></blockquote><p>Installing TFS Aggregator Web Service is a six step process:</p><ol><li><a href=#grant-access-to-vststfs>Grant access to VSTS/TFS</a></li><li><a href=#deploy-tfsaggregator-webhooks-web-application>Deploy TfsAggregator web application</a></li><li><a href=#configure-tfs-aggregator>Configure TFS Aggregator</a></li><li><a href=#define-the-policy>Define the policy</a></li><li><a href=#setup-logging-optional>Setup logging (optional)</a></li><li><a href=#setup-the-web-hooks-in-tfs-vsts>Setup the Web Hooks in TFS/VSTS</a></li></ol><h2 id=grant-access-to-vststfs>Grant access to VSTS/TFS
<a class=anchor href=#grant-access-to-vststfs>#</a></h2><p>There are three possible options to grant access. In most cases you will have to change the configuration later using the values collected in this step.</p><h3 id=1-using-a-personal-access-token>1. Using a Personal Access Token
<a class=anchor href=#1-using-a-personal-access-token>#</a></h3><p>a. Create a Personal Access Token <img src=./0-PAT1.png alt="Create Personal Access Token  screenshot"></p><blockquote><p>Leave <strong>All scopes</strong> select; TFS Aggregator use the old Object Model (see <a href="https://social.msdn.microsoft.com/Forums/vstudio/en-US/5564cb2b-4e46-4a41-b12c-bc50304c777b/authentication-issue-using-personal-access-token-when-all-options-of-selected-scope-are-selected?forum=TFService">Authentication issue using Personal Access Token when all options of &ldquo;Selected Scope&rdquo; are selected</a>).</p></blockquote><p>b. Capture Personal Access Token&rsquo;s value and store it for later <img src=./0-PAT2.png alt="Personal Access Token&amp;rsquo;s value"></p><blockquote><p>NOTE: this is per-account value you can use (User Profile/Security)</p></blockquote><h3 id=2-tfs-only-account-permissions>2. [TFS only] Account permissions
<a class=anchor href=#2-tfs-only-account-permissions>#</a></h3><p>instead of a PAT, you can give permission to the account running the Application Pool (see <a href=https://tfsaggregator.github.io/admin/troubleshooting/>Troubleshooting</a>)</p><h3 id=3-tfs-only-explicit-credentials>3. [TFS only] Explicit credentials
<a class=anchor href=#3-tfs-only-explicit-credentials>#</a></h3><p>or put username and password in clear text in the <code>/AggregatorConfiguration/runtime/authentication</code> node of the policy file</p><p>If you do not allow access expect a similar error
<img src=./0-error.png alt="Access denied"></p><h2 id=deploy-tfsaggregator-web-application>Deploy TfsAggregator web application
<a class=anchor href=#deploy-tfsaggregator-web-application>#</a></h2><h3 id=1-tfs-only-install-on-iis>1. [TFS only] Install on IIS
<a class=anchor href=#1-tfs-only-install-on-iis>#</a></h3><p>To install TfsAggregator web application you can use the <code>Deploy-TfsAggregatorWebHooks.ps1</code> as a sample script</p><ul><li>use SSL to avoid exposing credentials</li><li>the account running Aggregator application pool must have proper permissions on the target TFS <em>or</em> you set some credentials in the policy file</li></ul><h3 id=2-deploy-to-azure>2. Deploy to Azure
<a class=anchor href=#2-deploy-to-azure>#</a></h3><p>Use the <a href=https://azuredeploy.net/><img src=http://azuredeploy.net/deploybutton.png alt="Deploy to Azure"></a> button.
This is the simplest option for VSTS.</p><p>In the wizard specify the</p><p><img src=./1-deploy1.png alt></p><p><img src=./1-deploy2.png alt></p><p><img src=./1-deploy3.png alt></p><p>Please take note of the URL for the next steps.</p><p>You can check that the deploy worked, by opening a browser to the above URL appending <code>/api/workitem</code></p><p><img src=./1-deploy4-validate.png alt></p><h2 id=configure-tfs-aggregator>Configure TFS Aggregator
<a class=anchor href=#configure-tfs-aggregator>#</a></h2><p>To edit the deployed files, use Kudu console</p><p><img src=./2-config1.png alt="Kudu console"></p><p>at the <code>https://</code>&lt;name_chosen_in_previous_step><code>.scm.azurewebsites.net</code> URL. Navigate to <code>site\wwwroot</code> folder via <strong>Debug console</strong> menu.</p><p><img src=./2-config2.png alt></p><h3 id=add-users-to-webconfig-file>Add users to <code>web.config</code> file
<a class=anchor href=#add-users-to-webconfig-file>#</a></h3><p>Add at least one user in the <code>Users</code> section</p><pre><code>  &lt;Users&gt;
    &lt;add key=&quot;vsts&quot; value=&quot;P@ssw0rd!&quot; /&gt;
  &lt;/Users&gt;
</code></pre><h3 id=configure-the-policy-mapping>Configure the policy mapping
<a class=anchor href=#configure-the-policy-mapping>#</a></h3><p>Define the <code>policyFilePath</code> in <code>web.config</code>; the default value is the static path of the sample policy.</p><p><img src=./2-config3.png alt></p><p>Instead of a static path you can use a variable value from the incoming request e.g. <code>&lt;add key="policyFilePath" value="~/App_Data/{CollectionId}.policies" /></code>.
The possible variables for <code>policyFilePath</code>, extracted from the incoming request data are:</p><ul><li><code>{EventType}</code> could be <code>workitem.created</code> <code>workitem.updated</code> <code>workitem.restored</code> or <code>workitem.deleted</code></li><li><code>{AccountId}</code> Guid of VSTS Account (TFS 2017 or later)</li><li><code>{CollectionId}</code> Guid of collection</li><li><code>{TeamProject}</code> name of the Team Project</li><li><code>{TfsCollectionUri}</code> URL of the collection</li></ul><h2 id=define-the-policy>Define the policy
<a class=anchor href=#define-the-policy>#</a></h2><p>Navigate to the <code>App_Data</code> folder to edit the policy files</p><p><img src=./2-config4.png alt></p><blockquote><p>The default HelloWorld policy works for any kind of work items.</p></blockquote><h3 id=specify-authentication-in-the-policy>Specify Authentication in the policy
<a class=anchor href=#specify-authentication-in-the-policy>#</a></h3><p>The <code>runtime/authentication</code> element accept two new options</p><ol><li>Explicit credentials
<code>&lt;authentication username="DOMAIN\user" password="***" /></code>
not much secure, but handy for testing and some edge scenario</li><li>Personal Access Token (obtained on step 1)
<code>&lt;authentication personalToken="***" /></code></li></ol><p>In the policies you may have to set the credentials chosen in the first step, e.g. the PAT.</p><p><img src=./2-config5.png alt="Personal Access Token in Policy file"></p><h2 id=setup-logging-optional>Setup logging (optional)
<a class=anchor href=#setup-logging-optional>#</a></h2><p>This step is not mandatory, but recommended in the initial phase.
See <a href=https://tfsaggregator.github.io/admin/logging/#capturing-log-on-azure>Capturing Log On Azure</a>.</p><h2 id=setup-the-web-hooks-in-tfsvsts>Setup the Web Hooks in TFS/VSTS
<a class=anchor href=#setup-the-web-hooks-in-tfsvsts>#</a></h2><p>This is the last step: setup the caller, i.e. configure VSTS/TFS to invoke TFS Aggregator (see also <a href=https://www.visualstudio.com/en-us/docs/integrate/get-started/service-hooks/services/webhooks>Web Hooks</a>).</p><h3 id=using-powershell>Using Powershell
<a class=anchor href=#using-powershell>#</a></h3><p>In the <code>samples</code> folder you can find the <code>Create-Subscriptions.ps1</code> Powershell script to quickly setup the subscription.
It requires six arguments and creates the subcription for create, update and restore events.</p><table><thead><tr><th>Argument</th><th>Description</th><th>Sample value</th></tr></thead><tbody><tr><td>tfsURL</td><td>TFS/VSTS base URL</td><td><code>https://me.visualstudio.com/</code></td></tr><tr><td>ProjectName</td><td>TFS/VSTS project name</td><td><code>My Project</code></td></tr><tr><td>PersonalAccessToken</td><td>Personal Access Token generated in step 1</td><td><code>jocxco3i7twydcif25bh7yysbodwnq4ppuannhro4yryfcbab4na</code></td></tr><tr><td>aggregatorURL</td><td>URL of TFS Aggregator Web Service API</td><td><code>https://mytfsaggregator.azurewebsites.net/api/workitem/</code></td></tr><tr><td>aggregatorUsername</td><td>Username listed in TFS Aggregator Web Service <code>web.config</code></td><td><code>vsts</code></td></tr><tr><td>aggregatorPassword</td><td>Password for the above</td><td><code>P@ssw0rd!</code></td></tr></tbody></table><blockquote><p>The <code>workitem.deleted</code> fails with error <code>TF26198: The work item does not exist, or you do not have permission to access it.</code>
This is an issue with VSTS/TFS that we cannot solve.</p></blockquote><h3 id=manual-configuration>Manual configuration
<a class=anchor href=#manual-configuration>#</a></h3><blockquote><p>NOTE: this is a per-project configuration (Project/Admin).</p></blockquote><p><img src=./4-hooks1.png alt></p><p><img src=./4-hooks2.png alt></p><p>Select <strong>Web Hooks</strong>
<img src=./4-hooks3.png alt></p><p>Select the triggering event
<img src=./4-hooks4.png alt></p><blockquote><p>You may have to repeat this step for all four event:</p><ul><li>New/created</li><li>Change/updated</li><li>Delete</li><li>Restore</li></ul></blockquote><p>Insert the URL, e.g. <code>https://</code>&lt;name_chosen_in_deploy_step><code>.azurewebsites.net/api/workitem</code> and one user listed in TFS Aggregator <code>web.config</code> file.</p><p><img src=./4-hooks5.png alt></p><blockquote><p>NOTE the <strong>Test</strong> button above may send a well-formed document or not, so to test if everything works you really must create/modify some work item.</p></blockquote><p>This is the result with a single hooked event.
<img src=./4-hooks6.png alt="First service hook"></p><p>And after all four events are defined.
<img src=./4-hooks7.png alt="Four service hooks, one per event"></p><h2 id=final-testing>Final testing
<a class=anchor href=#final-testing>#</a></h2><p>At this point the configuration is complete and you can test, e.g. creating a new work item.</p><p><img src=./5-test1.png alt="New Work Item"></p><p>You see in the <strong>Service Hooks</strong> page</p><p><img src=./5-test2.png alt="Service Hooks page after a few calls"></p><p>the success or failure.
Remember that you can see the TFS Aggregator log to help troubleshooting.
<img src=./3-log3.png alt="Content of a log file"></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/commit/bc19aa3632abf205a0b01bacf2dd7fc6b95ac17d title="Last modified by Giulio Vian | June 27, 2020" target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/calendar.svg class=book-icon alt=Calendar>
<span>June 27, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/edit/master/content//docs/v2/admin/install-webhooks/index.md target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#grant-access-to-vststfs>Grant access to VSTS/TFS</a><ul><li><a href=#1-using-a-personal-access-token>1. Using a Personal Access Token</a></li><li><a href=#2-tfs-only-account-permissions>2. [TFS only] Account permissions</a></li><li><a href=#3-tfs-only-explicit-credentials>3. [TFS only] Explicit credentials</a></li></ul></li><li><a href=#deploy-tfsaggregator-web-application>Deploy TfsAggregator web application</a><ul><li><a href=#1-tfs-only-install-on-iis>1. [TFS only] Install on IIS</a></li><li><a href=#2-deploy-to-azure>2. Deploy to Azure</a></li></ul></li><li><a href=#configure-tfs-aggregator>Configure TFS Aggregator</a><ul><li><a href=#add-users-to-webconfig-file>Add users to <code>web.config</code> file</a></li><li><a href=#configure-the-policy-mapping>Configure the policy mapping</a></li></ul></li><li><a href=#define-the-policy>Define the policy</a><ul><li><a href=#specify-authentication-in-the-policy>Specify Authentication in the policy</a></li></ul></li><li><a href=#setup-logging-optional>Setup logging (optional)</a></li><li><a href=#setup-the-web-hooks-in-tfsvsts>Setup the Web Hooks in TFS/VSTS</a><ul><li><a href=#using-powershell>Using Powershell</a></li><li><a href=#manual-configuration>Manual configuration</a></li></ul></li><li><a href=#final-testing>Final testing</a></li></ul></nav></aside></main></body></html>