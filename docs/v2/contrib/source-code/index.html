<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This page explains the design and internal organization of TFS Aggregator v2&rsquo;s code. If you want to rebuild, customize, submit changes this is the place to start.
Major Components #  The Aggregator.Core assembly contains the logic to process a Work Item and run the aggregate scripts. It is normally used by Aggregator.ServerPlugin which intercept the TFS server side events and forward them to Aggregator.Core. Aggregator.ConsoleApp is a simple console app that helps users in developing and testing policies without installing the server plugin."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Source Code"><meta property="og:description" content="This page explains the design and internal organization of TFS Aggregator v2&rsquo;s code. If you want to rebuild, customize, submit changes this is the place to start.
Major Components #  The Aggregator.Core assembly contains the logic to process a Work Item and run the aggregate scripts. It is normally used by Aggregator.ServerPlugin which intercept the TFS server side events and forward them to Aggregator.Core. Aggregator.ConsoleApp is a simple console app that helps users in developing and testing policies without installing the server plugin."><meta property="og:type" content="article"><meta property="og:url" content="https://tfsaggregator.github.io/docs/v2/contrib/source-code/"><meta property="article:modified_time" content="2020-06-27T22:31:19+01:00"><title>Source Code | Aggregator</title><link rel=manifest href=https://tfsaggregator.github.io/manifest.json><link rel=icon href=https://tfsaggregator.github.io/favicon.png type=image/x-icon><link rel=stylesheet href=https://tfsaggregator.github.io/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI="><script defer src=https://tfsaggregator.github.io/en.search.min.38845e090faac8929f975f25d92aad1b49253ccd75947a9c1277e5acb3c84d80.js integrity="sha256-OIReCQ+qyJKfl18l2SqtG0klPM11lHqcEnflrLPITYA="></script></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=https://tfsaggregator.github.io/><span>Aggregator</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://tfsaggregator.github.io/docs/v3/>Aggregator CLI</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/>Setup</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/production/>Production</a><ul></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/>Commands</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/commands/command-examples/>Examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/>Rules</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-basic/>Basic examples</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-advanced/>Advanced examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/>Design</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/design/parallelism/>Parallelism</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/>Contribute</a><ul></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/>TFS Aggregator v2</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/intro/ class=collapsed>Introduction</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/ class=collapsed>Users' Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/ class=collapsed>Administrator Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/ class=collapsed>Contributing</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/developer-intro/>Introduction to Contributors</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/source-code/ class=active>Source Code</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/local-build/>Local Build</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/debugging/debugging/>Debugging</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/continuous-integration/>Continuous Integration</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/documentation/>Documentation</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/changelog/>Changelog</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=https://tfsaggregator.github.io/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Source Code</strong>
<label for=toc-control><img src=https://tfsaggregator.github.io/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#major-components>Major Components</a></li><li><a href=#source-code-organization-up-to-v221>Source Code Organization (up to v2.2.1)</a></li><li><a href=#source-code-organization-up-to-v23-and-later>Source Code Organization (up to v2.3 and later)</a></li><li><a href=#policy-data>Policy data</a></li><li><a href=#object-model>Object Model</a></li><li><a href=#scripting>Scripting</a></li><li><a href=#logging>Logging</a></li><li><a href=#whats-next>What&rsquo;s next</a></li></ul></nav></aside></header><article class=markdown><p>This page explains the design and internal organization of TFS Aggregator v2&rsquo;s code.
If you want to rebuild, customize, submit changes this is the place to start.</p><h2 id=major-components>Major Components
<a class=anchor href=#major-components>#</a></h2><p>The <code>Aggregator.Core</code> assembly contains the logic to process a Work Item and run the aggregate scripts.
It is normally used by <code>Aggregator.ServerPlugin</code> which intercept the TFS server side events and forward them to Aggregator.Core.
<code>Aggregator.ConsoleApp</code> is a simple console app that helps users in developing and testing policies without installing the server plugin.
<code>Aggregator.WebHooks</code> (new in 2.3) is a WebAPI application that uses Web Hooks to receive notifications from TFS/VSTS.</p><h2 id=source-code-organization-up-to-v221>Source Code Organization (up to v2.2.1)
<a class=anchor href=#source-code-organization-up-to-v221>#</a></h2><p>The project is available on <a href=https://github.com/tfsaggregator/tfsaggregator>GitHub</a>.
We use a simple master/develop/pull-request branching scheme.
All the source is available in the <code>TFS-Aggregator-2.sln</code> Visual Studio 2015 solution.
To produce the MSI, see <a href=https://tfsaggregator.github.io/contrib/local-build>Local build</a>.</p><h2 id=source-code-organization-up-to-v23-and-later>Source Code Organization (up to v2.3 and later)
<a class=anchor href=#source-code-organization-up-to-v23-and-later>#</a></h2><p>Code is split in three repositories:</p><ol><li><em>tfsaggregator-core</em> contains the core code of Aggregator; there are 2 different project files <code>Aggregator.Core.Plugin.csproj</code> and <code>Aggregator.Core.WebHooks.csproj</code> both producing <code>Aggregator.Core.dll</code>, they <strong>must</strong> be manually synched using a tool like <a href=https://www.scootersoftware.com/>Beyond Compare</a> or <a href=http://winmerge.org/>WinMerge</a>; in addition the repo holds the Unit tests.</li><li><em>tfsaggregator</em> use <em>tfsaggregator-core</em> as submodule; it contains the <code>tfs-aggregator-plugin.sln</code> solution that produce the Server Plugin; see <a href=https://tfsaggregator.github.io/contrib/local-build>Local build</a> for MSI details.</li><li><em>tfsaggregator-webhooks</em> use <em>tfsaggregator-core</em> as submodule; it contains the <code>TFS-Aggregator-WebHook.sln</code> solution that produce the Web Service which is not included in the MSI</li></ol><blockquote><p><strong>Git Tip</strong>: add remotes to each submodule so they reference each other and you can quickly synchronize the local folders.</p></blockquote><h2 id=policy-data>Policy data
<a class=anchor href=#policy-data>#</a></h2><p>Aggregator parses the Policy file at start. The logic is contained in Aggregator.Core/Configuration;
whose entry point is the <code>Aggregator.Core.Configuration.TFSAggregatorSettings</code> class.
That class is also the root of the configuration data model: Aggregator code gets a reference to a <code>TFSAggregatorSettings</code> instance to configure.</p><p>You can populate this class from a different source like a database.</p><h2 id=object-model>Object Model
<a class=anchor href=#object-model>#</a></h2><p>Aggregator&rsquo;s Object Model solves some objectives:</p><ol><li>simplifying the scripts</li><li>decouple from TFS Object Model</li><li>Ease mocking i.e. testing</li></ol><p>You find the OM interfaces in Aggregator.Core/Interfaces and the implementation for the TFS OM in Aggregator.Core/Facade.</p><p>See <a href=https://tfsaggregator.github.io/using/scripting>Scripting</a> for an introduction.</p><h2 id=scripting>Scripting
<a class=anchor href=#scripting>#</a></h2><p>Aggregator.Core/Script contains the build and execute logic for all scripting engines.
For C# and VB, the script code is compiled once and the produced assembly is reused until the plug-in restarts.
The <code>DotNetScriptEngine</code> base class contains all the logic while <code>CSharpScriptEngine</code> and <code>VBNetScriptEngine</code> define how to sew the script&rsquo;s code snippets together.
Powershell support is experimental.</p><h2 id=logging>Logging
<a class=anchor href=#logging>#</a></h2><p>The Core is decoupled from the logging sub-system: interesting events are pushed via the <code>Aggregator.Core.ILogEvents</code> interface that each client must implement.
This way the same event generate a message in the log file or on the console. Important messages create EventLog messages on the server but not on the console application.</p><p>To add a message you have to:</p><ol><li>add a method to <code>ILogEvents</code> interface</li><li>implement the method in <code>TextLogComposer</code> class</li></ol><blockquote><p>Note that the calling site is invoking a method passing typed parameters.
<code>TextLogComposer</code> implementation set the message level and compose the text properly formatting the parameters.</p></blockquote><h2 id=whats-next>What&rsquo;s next
<a class=anchor href=#whats-next>#</a></h2><p>Please read <a href=https://tfsaggregator.github.io/contrib/local-build>Local build</a>, <a href=https://tfsaggregator.github.io/contrib/debugging>Debugging</a> and <a href=https://tfsaggregator.github.io/admin/troubleshooting>Troubleshooting</a> to get a complete picture.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/commit/f6e2c8ff84269d2c5dd9566d3aa35ffe1114ab43 title="Last modified by Giulio Vian | June 27, 2020" target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/calendar.svg class=book-icon alt=Calendar>
<span>June 27, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/edit/master/content//docs/v2/contrib/source-code.md target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#major-components>Major Components</a></li><li><a href=#source-code-organization-up-to-v221>Source Code Organization (up to v2.2.1)</a></li><li><a href=#source-code-organization-up-to-v23-and-later>Source Code Organization (up to v2.3 and later)</a></li><li><a href=#policy-data>Policy data</a></li><li><a href=#object-model>Object Model</a></li><li><a href=#scripting>Scripting</a></li><li><a href=#logging>Logging</a></li><li><a href=#whats-next>What&rsquo;s next</a></li></ul></nav></aside></main></body></html>