<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Docker configuration #  Prerequisites #  Azure DevOps PAT #  You must have an Azure DevOps Personal Access Token as described here to authenticate against Azure DevOps.
SSL Certificate #  Create / get a certificate in PFX format, name it aggregator.pfx. If you have a PEM (.pem, .crt, .cer) or PKCS#7/P7B (.p7b, .p7c) file, you can use OpenSSL to produce an equivalent PFX format (e.g. follow this guide)."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Docker configuration"><meta property="og:description" content="Aggregator Documentation"><meta property="og:type" content="website"><meta property="og:url" content="https://tfsaggregator.github.io/docs/v3/setup/docker/"><title>Docker configuration | Aggregator</title><link rel=manifest href=https://tfsaggregator.github.io/manifest.json><link rel=icon href=https://tfsaggregator.github.io/favicon.png type=image/x-icon><link rel=stylesheet href=https://tfsaggregator.github.io/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI="><script defer src=https://tfsaggregator.github.io/en.search.min.94a8808a5458db4a7a736bbfe9ef45f82e38ce011fb3d781778fd81df04e4aa7.js integrity="sha256-lKiAilRY20p6c2u/6e9F+C44zgEfs9eBd4/YHfBOSqc="></script><link rel=alternate type=application/rss+xml href=https://tfsaggregator.github.io/docs/v3/setup/docker/index.xml title=Aggregator></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=https://tfsaggregator.github.io/><span>Aggregator</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://tfsaggregator.github.io/docs/v3/>Aggregator 3 (CLI)</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/>Setup</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azdo-authn/>Azure DevOps Personal Access Token</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azure/>Azure CLI Setup</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/production/>Azure Production</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/docker/ class=active>Docker configuration</a><ul></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/>CLI Commands</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/commands/common-options/>Common options</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/authentication-commands/>Authentication commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/instance-commands/>Instance commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/rule-commands/>Rule commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/map-commands/>Mapping commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/info-commands/>Informational commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/command-examples/>Examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/>Rules</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-basic/>Basic examples</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-advanced/>Advanced examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/>Design</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/design/parallelism/>Parallelism</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/api/>REST API</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/>Contribute</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/pipelines/>Pipelines</a></li></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/>TFS Aggregator v2</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/intro/ class=collapsed>Introduction</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/ class=collapsed>Users' Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/ class=collapsed>Administrator Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/ class=collapsed>Contributing</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/changelog/>Changelog</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=https://tfsaggregator.github.io/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Docker configuration</strong>
<label for=toc-control><img src=https://tfsaggregator.github.io/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a><ul><li><a href=#azure-devops-pat>Azure DevOps PAT</a></li><li><a href=#ssl-certificate>SSL Certificate</a></li><li><a href=#define-the-set-of-valid-api-keys>Define the set of valid API Keys</a></li><li><a href=#shared-secret-with-cli-optional>Shared secret with CLI (optional)</a></li><li><a href=#volume-with-rule-files>Volume with Rule files</a></li></ul></li><li><a href=#test-the-container>Test the container</a></li><li><a href=#environment-variables>Environment Variables</a></li></ul></nav></aside></header><article class=markdown><h1 id=docker-configuration>Docker configuration
<a class=anchor href=#docker-configuration>#</a></h1><h2 id=prerequisites>Prerequisites
<a class=anchor href=#prerequisites>#</a></h2><h3 id=azure-devops-pat>Azure DevOps PAT
<a class=anchor href=#azure-devops-pat>#</a></h3><p>You must have an Azure DevOps Personal Access Token as described <a href=../azdo-authn/>here</a> to authenticate against Azure DevOps.</p><h3 id=ssl-certificate>SSL Certificate
<a class=anchor href=#ssl-certificate>#</a></h3><p>Create / get a certificate in PFX format, name it <code>aggregator.pfx</code>.
If you have a PEM (.pem, .crt, .cer) or PKCS#7/P7B (.p7b, .p7c) file, you can use OpenSSL to produce an equivalent PFX format (e.g. follow this <a href=https://www.ssl.com/how-to/create-a-pfx-p12-certificate-file-using-openssl/>guide</a>).</p><p>You can generate a <strong>test</strong> certificate with a similar PowerShell snippet.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$cert = New-SelfSignedCertificate -KeyLength 2048 -KeyAlgorithm RSA -Type SSLServerAuthentication -FriendlyName <span style=color:#e6db74>&#34;Aggregator&#34;</span> -NotAfter 2025-12-31 -Subject <span style=color:#e6db74>&#34;aggregator.example.com&#34;</span> -TextExtension @(<span style=color:#e6db74>&#34;2.5.29.17={text}DNS=aggregator.example.com&amp;IPAddress=127.0.0.1&amp;IPAddress=::1&#34;</span>)
$certPass = Read-Host -Prompt <span style=color:#e6db74>&#34;My password&#34;</span> -AsSecureString
Export-PfxCertificate -FilePath <span style=color:#e6db74>&#34;aggregator.pfx&#34;</span> -Cert $cert -Password $certPass
</code></pre></div><h3 id=define-the-set-of-valid-api-keys>Define the set of valid API Keys
<a class=anchor href=#define-the-set-of-valid-api-keys>#</a></h3><p>Add a file <code>apikeys.json</code>, similar to the following.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
  { <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;api-123457890abcdef1234567890abcdef&#34;</span> },
  { <span style=color:#f92672>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;api-23457890abcdef1234567890abcdef1&#34;</span> }
]
</code></pre></div><p>A valid API Key is made of 32 hexadecimal characters prefixed by <code>api-</code> for a total 36 chars.
In PowerShell</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#e6db74>&#34;api-</span>$( (New-Guid) <span style=color:#f92672>-replace</span> <span style=color:#e6db74>&#39;-&#39;</span>,<span style=color:#e6db74>&#39;&#39;</span> )<span style=color:#e6db74>&#34;</span>
</code></pre></div><p>or on Linux/Mac</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>echo <span style=color:#e6db74>&#34;api-</span><span style=color:#66d9ef>$(</span> uuidgen | tr -d <span style=color:#e6db74>&#39;-&#39;</span> <span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><p>or</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>echo <span style=color:#e6db74>&#34;api-</span><span style=color:#66d9ef>$(</span> openssl rand -hex <span style=color:#ae81ff>16</span> <span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><p>The API Key values will be used to authenticate the Web Hook call from Azure DevOps.</p><h3 id=shared-secret-with-cli-optional>Shared secret with CLI (optional)
<a class=anchor href=#shared-secret-with-cli-optional>#</a></h3><p>Define the environment variable <a href=../../commands#shared-secret-v10><code>Aggregator_SharedSecret</code></a> both at the container and where you launch the CLI.
This is required to use CLI commands like <a href=../../commands/map-commands/#maplocalrule-v10><code>map.local.rule</code></a> to configure Azure DevOps.</p><h3 id=volume-with-rule-files>Volume with Rule files
<a class=anchor href=#volume-with-rule-files>#</a></h3><p>Create a folder to contain the Rule files, e.g. <code>C:\aggregator-cli\docker\rules\</code> and copy there the Rule files.
Test the Rules before using the <a href=../../commands/rule-commands/#invokerule>invoke.rule</a> command.</p><h2 id=test-the-container>Test the container
<a class=anchor href=#test-the-container>#</a></h2><p>Pull the latest image from Docker Hub using the version matching the operating system.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker pull tfsaggregator/aggregator3:latest
</code></pre></div><p>Example of running the container on Windows</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run --rm -it -p 5320:5320 -e Aggregator_VstsToken<span style=color:#f92672>=</span>********  -e ASPNETCORE_Kestrel__Certificates__Default__Password<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;********&#34;</span>  --mount type<span style=color:#f92672>=</span>bind,source<span style=color:#f92672>=</span>c:/src/github.com/tfsaggregator/aggregator-cli/docker/secrets/,target<span style=color:#f92672>=</span>c:/secrets --mount type<span style=color:#f92672>=</span>bind,source<span style=color:#f92672>=</span>c:/src/github.com/tfsaggregator/aggregator-cli/docker/rules/,target<span style=color:#f92672>=</span>c:/rules   tfsaggregator/aggregator3:latest
</code></pre></div><p>Example of running the container on Linux</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run --rm -it -p 5320:5320 -e Aggregator_VstsToken<span style=color:#f92672>=</span>******** -e ASPNETCORE_Kestrel__Certificates__Default__Password<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;********&#34;</span>  -v /mnt/c/src/github.com/tfsaggregator/aggregator-cli/docker/rules:/rules  -v /mnt/c/src/github.com/tfsaggregator/aggregator-cli/docker/secrets:/secrets   tfsaggregator/aggregator3:latest
</code></pre></div><p>Clearly, replace the asterisks (<code>********</code>) with secret values.</p><p>The output should be similar to the following</p><pre><code class=language-log data-lang=log>Docker mode.
info: Microsoft.Hosting.Lifetime[0]
      Now listening on: https://[::]:5320
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\app
</code></pre><blockquote class="book-hint info">Azure DevOps refuses localhost connections for Web hooks. The container must be exposed using a DNS name.</blockquote><p>Try access the <code>/config/status</code> endpoint to check connectivity, e.g.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -X GET https://aggregator.example.com:5320/config/status
</code></pre></div><p>Add the <code>--insecure</code> if you are using a self-signed certificate (not recommended for production).
If your system hasn&rsquo;t curl, you can test using PowerShell</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>Invoke-RestMethod -Method Get -Uri https<span style=color:#960050;background-color:#1e0010>:</span>//aggregator.example.com<span style=color:#960050;background-color:#1e0010>:</span>5320/config/status
</code></pre></div><p>Add <code>-SkipCertificateCheck</code> if you are using a self-signed certificate (not recommended).</p><h2 id=environment-variables>Environment Variables
<a class=anchor href=#environment-variables>#</a></h2><p>The container is configurable using these environment variables.</p><table><thead><tr><th>Variable</th><th>Use</th><th align=center>Linux Default value</th><th align=center>Windows Default value</th></tr></thead><tbody><tr><td><code>ASPNETCORE_URLS</code></td><td>Set the listening port</td><td align=center><code>https://*:5320</code></td><td align=center><code>https://*:5320</code></td></tr><tr><td><code>ASPNETCORE_Kestrel__Certificates__Default__Path</code></td><td>SSL Certificate</td><td align=center><code>/secrets/aggregator.pfx</code></td><td align=center><code>c:\\secrets\\aggregator.pfx</code></td></tr><tr><td><code>ASPNETCORE_Kestrel__Certificates__Default__Password</code></td><td>SSL Certificate password</td><td align=center></td><td></td></tr><tr><td><code>Logging__LogLevel__Aggregator</code></td><td>Level of Application Logging</td><td align=center><code>Debug</code></td><td align=center><code>Debug</code></td></tr><tr><td><code>Aggregator_ApiKeysPath</code></td><td>Valid API Keys</td><td align=center><code>/secrets/apikeys.json</code></td><td align=center><code>c:\\secrets\\apikeys.json</code></td></tr><tr><td><code>Aggregator_SharedSecret</code></td><td>Shared password to authenticate CLI</td><td align=center></td><td></td></tr><tr><td><code>Aggregator_RulesPath</code></td><td>Directory with Rule files</td><td align=center><code>/rules</code></td><td align=center><code>c:\\rules</code></td></tr><tr><td><code>Aggregator_VstsTokenType</code></td><td>Type of Azure DevOps authentication</td><td align=center><code>PAT</code></td><td align=center><code>PAT</code></td></tr><tr><td><code>Aggregator_VstsToken</code></td><td>Azure DevOps Personal Authentication Token</td><td align=center></td><td></td></tr><tr><td><code>AGGREGATOR_TELEMETRY_DISABLED</code></td><td>Control telemetry</td><td align=center><code>false</code></td><td align=center><code>false</code></td></tr></tbody></table><p>We do not recommend using unsecured HTTP. The certificate should be trusted by the Azure DevOps instance.<blockquote class="book-hint info">Note that the backslash character (<code>\</code>) must be doubled for Windows paths.</blockquote></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/commit/6a7f7214076ec3595b62f5c58a16817466dbf3b3 title="Last modified by Giulio Vian | August 31, 2020" target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/calendar.svg class=book-icon alt=Calendar>
<span>August 31, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/edit/master/content//docs/v3/setup/docker/_index.md target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a><ul><li><a href=#azure-devops-pat>Azure DevOps PAT</a></li><li><a href=#ssl-certificate>SSL Certificate</a></li><li><a href=#define-the-set-of-valid-api-keys>Define the set of valid API Keys</a></li><li><a href=#shared-secret-with-cli-optional>Shared secret with CLI (optional)</a></li><li><a href=#volume-with-rule-files>Volume with Rule files</a></li></ul></li><li><a href=#test-the-container>Test the container</a></li><li><a href=#environment-variables>Environment Variables</a></li></ul></nav></aside></main></body></html>