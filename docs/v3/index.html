<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Aggregator 3 (CLI & Docker) #  This is the successor to renowned TFS Aggregator. The current Server Plugin version (2.x) will be maintained to support TFS. The Web Service flavour will be discontinued in favour of this new tool for two reasons:
 deployment and configuration of Web Service was too complex for most users; both the Plugin and the Service rely heavily on TFS Object Model which is deprecated."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Aggregator 3 (CLI)"><meta property="og:description" content="Aggregator Documentation"><meta property="og:type" content="website"><meta property="og:url" content="https://tfsaggregator.github.io/docs/v3/"><title>Aggregator 3 (CLI) | Aggregator</title><link rel=manifest href=https://tfsaggregator.github.io/manifest.json><link rel=icon href=https://tfsaggregator.github.io/favicon.png type=image/x-icon><link rel=stylesheet href=https://tfsaggregator.github.io/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI="><script defer src=https://tfsaggregator.github.io/en.search.min.263c267bf95d1c23f1b0c06c2c1fb308af9a9586dda823de40b1d3efa4cf515e.js integrity="sha256-Jjwme/ldHCPxsMBsLB+zCK+alYbdqCPeQLHT76TPUV4="></script><link rel=alternate type=application/rss+xml href=https://tfsaggregator.github.io/docs/v3/index.xml title=Aggregator></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=https://tfsaggregator.github.io/><span>Aggregator</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://tfsaggregator.github.io/docs/v3/ class=active>Aggregator 3 (CLI)</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/>Setup</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azdo-authn/>Azure DevOps Personal Access Token</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azure/>Azure CLI Setup</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/docker/>Docker configuration</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/production/>Production on Azure</a><ul></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/>CLI Commands</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/commands/common-options/>Common options</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/authentication-commands/>Authentication commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/instance-commands/>Instance commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/rule-commands/>Rule commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/map-commands/>Mapping commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/info-commands/>Informational commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/command-examples/>Examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/>Rules</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/rules/directives/>Directives</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/workitem/>WorkItem event objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/common-rule-objects/>Common objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-basic/>Basic examples</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-advanced/>Advanced examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/>Design</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/design/caveat/>Caveats</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/parallelism/>Parallelism</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/api/>REST API</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/troubleshoot/>Troubleshoot</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/>Contribute</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/pipelines/>Pipelines</a></li></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/>TFS Aggregator v2</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/intro/ class=collapsed>Introduction</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/ class=collapsed>Users' Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/ class=collapsed>Administrator Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/ class=collapsed>Contributing</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/changelog/>Changelog</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=https://tfsaggregator.github.io/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Aggregator 3 (CLI)</strong>
<label for=toc-control><img src=https://tfsaggregator.github.io/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#releases>Releases</a></li><li><a href=#major-features>Major features</a><ul><li><a href=#what-you-can-and-cannot-do>What you can and cannot do</a></li></ul></li><li><a href=#requirements>Requirements</a><ul><li><a href=#cli--azure>CLI & Azure</a></li><li><a href=#docker>Docker</a></li></ul></li><li><a href=#how-the-cli-works-with-azure-functions>How the CLI works with Azure Functions</a></li><li><a href=#cli-authentication>CLI Authentication</a></li><li><a href=#cli-usage>CLI Usage</a><ul><li><a href=#cli-verbs>CLI Verbs</a></li></ul></li><li><a href=#how-the-docker-image-works>How the Docker image works</a></li><li><a href=#rule-language>Rule language</a></li><li><a href=#maintenance>Maintenance</a></li><li><a href=#troubleshooting>Troubleshooting</a></li><li><a href=#contributing>Contributing</a></li></ul></nav></aside></header><article class=markdown><h1 id=aggregator-3-cli--docker>Aggregator 3 (CLI & Docker)
<a class=anchor href=#aggregator-3-cli--docker>#</a></h1><p>This is the successor to renowned TFS Aggregator.
The current Server Plugin version (2.x) will be maintained to support TFS.
The Web Service flavour will be discontinued in favour of this new tool for two reasons:</p><ul><li>deployment and configuration of Web Service was too complex for most users;</li><li>both the Plugin and the Service rely heavily on TFS Object Model which is <a href=https://docs.microsoft.com/en-us/azure/devops/integrate/concepts/wit-client-om-deprecation>deprecated</a>.</li></ul><p>Aggregator 3.x supports two scenarios:</p><ol><li>Azure DevOps Services with Rules running in Azure Functions.</li><li>Docker container running in the cloud or on-premise. [v1.0]</li></ol><p>The latter permits replacing the Server Plugin after migrating the Rule code.</p><h2 id=releases>Releases
<a class=anchor href=#releases>#</a></h2><p><a href=https://github.com/tfsaggregator/aggregator-cli/releases target=_blank class=book-btn>Download CLI</a>
<a href=https://hub.docker.com/r/tfsaggregator/aggregator3 target=_blank class=book-btn>Docker Image from DockerHub</a>
<a href=https://github.com/orgs/tfsaggregator/packages/container/package/aggregator3 target=_blank class=book-btn>Docker Image from GitHub Container Registry</a></p><p>Aggregator is evolving rapidly and some feature are not available on older versions.
A release number like <code>[v0.9.11]</code> signals the version when the feature was introduced.
A complete list of releases including log of changes is <a href=https://github.com/tfsaggregator/aggregator-cli/releases>in GitHub</a>.</p><h2 id=major-features>Major features
<a class=anchor href=#major-features>#</a></h2><ul><li>use of new Azure DevOps REST API</li><li>simple deployment via CLI tool or Docker container</li><li>Rule language similar to TFS Aggregator v2</li></ul><h3 id=what-you-can-and-cannot-do>What you can and cannot do
<a class=anchor href=#what-you-can-and-cannot-do>#</a></h3><p>Aggregator is always 1 save away from the Azure DevOps User Interface: it does not intercept anything. Aggregator is notified <em>after</em> Azure DevOps commits user changes to the database. It can do fancy calculations and can work across hierarchies and queries (which the built-in rules won&rsquo;t allow), but needs additional round-trips to Azure DevOps. Thus it is only reactive and may need a UI refresh for calculations to show up.
It cannot be used to block updates either. The data has already been saved once the aggregator runs. You could do compensating changes, but can&rsquo;t prevent them.
When aggregator changes a value, it will also invoke itself once more (it runs on every change), so Aggregator rules must run idempotent.<br>Please go to the <a href=design/>Design</a> section for further details.</p><h2 id=requirements>Requirements
<a class=anchor href=#requirements>#</a></h2><p>To write a Rule is required some basic knowledge of C# language and Azure Boards.
In addition you need:</p><ul><li>an Azure DevOps Services Project</li><li>a Personal Access Token with sufficient permissions on the Project</li></ul><h3 id=cli--azure>CLI & Azure
<a class=anchor href=#cli--azure>#</a></h3><p>The CLI scenario has two additional requirements:</p><ul><li>an Azure Subscription</li><li>a Service Principal with, at least, Contributor permission on a Resource Group of the Subscription</li></ul><h3 id=docker>Docker
<a class=anchor href=#docker>#</a></h3><p>The Docker scenario requires:</p><ul><li>an SSL Certificate</li><li>an host for Docker containers (Windows or Linux)</li></ul><h2 id=how-the-cli-works-with-azure-functions>How the CLI works with Azure Functions
<a class=anchor href=#how-the-cli-works-with-azure-functions>#</a></h2><p>As the name implies, this is a command line tool: you download the latest aggregator-cli*.zip appropriate for your platform from GitHub <a href=https://github.com/tfsaggregator/aggregator-cli/releases>releases</a> and unzip it on your client machine.
Read more below in the <a href=#usage>Usage</a> section.</p><p>Through the CLI you create one or more Azure Functions in your Subscription. The Functions use a library named Aggregator <strong>Runtime</strong> to run your <strong>Rules</strong>.
A Rule is code that reacts to one or more Azure DevOps event; currently, the only language for writing rules is C#.</p><p>The CLI automatically checks GitHub Releases to ensure that you use the more recent version of Aggregator Runtime available. To avoid automatic upgrades, specify the Runtime version or point to a specific Runtime package file, using an <code>http:</code> or <code>file:</code> URL.</p><p>After you setup the Rules in Azure, you must add at least one <strong>Mapping</strong>. A mapping is an Azure DevOps Service Hook that send a message to the Azure Function when a specific event occurs. Currently we support only Work Item events.
When triggered, the Azure DevOps Service Hook invokes a single Aggregator Rule i.e. the Azure Function hosting the Rule code. Azure DevOps saves the Azure Function Key in the Service Hook configuration.</p><p>You can deploy the same Rule in different Instances, map the same Azure DevOps event to many Rules or map multiple events to the same Rule: you choose the best way to organize your code.</p><h2 id=cli-authentication>CLI Authentication
<a class=anchor href=#cli-authentication>#</a></h2><p>You must instruct Aggregator which credential to use.
To do this, run the <code>login.azure</code> and <code>login.ado</code> commands.</p><p>To create the credentials, you need an Azure Service Principal and a Azure DevOps Personal Access Token. Full details in the <a href=setup/>Setup</a> section.</p><p>Aggregator stores the logon credentials locally and expires them after 2 hours.</p><p>The PAT is also stored in the Azure Function settings: <strong>whoever has access to the Resource Group can read it!</strong></p><p>The Service Principal must have Contributor permission to the Azure Subscription or, in alternative, pre-create the Resource Group in Azure and give the service account Contributor permission to the Resource Group.
<img src=setup/contributor-on-rg.png alt="Permission on existing Resource Group">
If you go this route, remember add the <code>--resourceGroup</code> to all commands requiring an instance.</p><p>For Docker only Azure DevOps logon is required.</p><h2 id=cli-usage>CLI Usage
<a class=anchor href=#cli-usage>#</a></h2><p>Download and unzip the latest CLI.zip file from <a href=https://github.com/tfsaggregator/aggregator-cli/releases>Releases</a>.
It requires <a href=https://dotnet.microsoft.com/download/dotnet-core/3.1>.Net Core 3.1</a> installed on the machine.
To run Aggregator run <code>aggregator-cli.exe</code> (Windows), <code>aggregator-cli</code> (Linux) or <code>dotnet aggregator-cli.dll</code> followed by a verb and its options.</p><h3 id=cli-verbs>CLI Verbs
<a class=anchor href=#cli-verbs>#</a></h3><p>There are about 20 commands described in detail at <a href=commands/>Commands</a>.</p><p>They can be grouped in a few categories:</p><ul><li>Authentication to logon into Azure and Azure DevOps.</li><li>Instance creation, configuration and update.</li><li>Rule deployment, configuration and update.</li><li>Mapping from Azure DevOps to Rules.</li><li>Informational commands, to read configuration.</li><li>Testing commands to validate configuration.</li></ul><p>Most commands manage Azure Function, but a few can be used in the Docker scenario.</p><p>We collected some usage scenarios at <a href=commands/command-examples/>Command Examples</a>.</p><h2 id=how-the-docker-image-works>How the Docker image works
<a class=anchor href=#how-the-docker-image-works>#</a></h2><p>Pull the latest image from <a href=https://hub.docker.com/repository/docker/tfsaggregator/aggregator3>Docker Hub</a>. It works on Linux and Windows.
Start a container with the image, setting configuration through environment variables.
The Rules are simply files on a Docker volume that the container uses.
The container must expose a port reachable from your Azure DevOps instance, either Server or Service.
Add one or web hook to Azure DevOps using the container URL. Use one Aggregator API Key to authenticate the call. You may use the CLI to add these mappings.</p><p>More details at <a href=setup/docker/>Docker configuration</a></p><h2 id=rule-language>Rule language
<a class=anchor href=#rule-language>#</a></h2><p>Currently we offer only C# as the language to write Rules. The Rules can access a few objects:</p><ul><li>The Current Work Item.</li><li>Work Item Store to retrieve additional Work Items.</li><li>The Event which triggered the Rule.</li><li>Project information.</li><li>A Logger object to track Rule steps.</li></ul><p>See <a href=rules/>Rule Language</a> for a list of objects and properties to use.
For examples see <a href=rules/rule-examples-basic/>Rule Examples</a>.</p><h2 id=maintenance>Maintenance
<a class=anchor href=#maintenance>#</a></h2><p>Aggregator stores the PAT in the Azure Function configuration. Before the PAT expire you should refresh it from Azure DevOps or save a new PAT using the <code>configure.instance</code> command.</p><p>Read <a href=setup/production/>Production Configuration and Administration</a> for recommendations on running Aggregator in production.</p><h2 id=troubleshooting>Troubleshooting
<a class=anchor href=#troubleshooting>#</a></h2><p>Tips and suggestion when things do not work are in the <a href=troubleshoot/>Troubleshoot</a> section.</p><h2 id=contributing>Contributing
<a class=anchor href=#contributing>#</a></h2><p>Details on building your own version and testing are in the <a href=contrib/>Contribute</a> section.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/commit/594f494734b3323b5253006854dfef4730c01407 title="Last modified by Jesse Houwing | August 10, 2022" target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/calendar.svg class=book-icon alt=Calendar>
<span>August 10, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/edit/master/content//docs/v3/_index.md target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#releases>Releases</a></li><li><a href=#major-features>Major features</a><ul><li><a href=#what-you-can-and-cannot-do>What you can and cannot do</a></li></ul></li><li><a href=#requirements>Requirements</a><ul><li><a href=#cli--azure>CLI & Azure</a></li><li><a href=#docker>Docker</a></li></ul></li><li><a href=#how-the-cli-works-with-azure-functions>How the CLI works with Azure Functions</a></li><li><a href=#cli-authentication>CLI Authentication</a></li><li><a href=#cli-usage>CLI Usage</a><ul><li><a href=#cli-verbs>CLI Verbs</a></li></ul></li><li><a href=#how-the-docker-image-works>How the Docker image works</a></li><li><a href=#rule-language>Rule language</a></li><li><a href=#maintenance>Maintenance</a></li><li><a href=#troubleshooting>Troubleshooting</a></li><li><a href=#contributing>Contributing</a></li></ul></nav></aside></main></body></html>