<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Advanced Rule examples #  Backlog work items: Auto-activate parent #  This is a more advanced version which has no hard coded work item type names. It moves a parent work item to active state (activates parent), if a child gets activated and both parent and child are backlog work items
//Method to check if a 'workItem' is in a 'Progress' state bool IsInProgress(WorkItemWrapper workItem, BacklogWorkItemTypeStates workItemType) { var concreteStateNames = workItemType?"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Advanced examples"><meta property="og:description" content="Advanced Rule examples #  Backlog work items: Auto-activate parent #  This is a more advanced version which has no hard coded work item type names. It moves a parent work item to active state (activates parent), if a child gets activated and both parent and child are backlog work items
//Method to check if a 'workItem' is in a 'Progress' state bool IsInProgress(WorkItemWrapper workItem, BacklogWorkItemTypeStates workItemType) { var concreteStateNames = workItemType?"><meta property="og:type" content="article"><meta property="og:url" content="https://tfsaggregator.github.io/docs/v3/rules/rule-examples-advanced/"><meta property="article:modified_time" content="2022-08-10T20:02:02+02:00"><title>Advanced examples | Aggregator</title><link rel=manifest href=https://tfsaggregator.github.io/manifest.json><link rel=icon href=https://tfsaggregator.github.io/favicon.png type=image/x-icon><link rel=stylesheet href=https://tfsaggregator.github.io/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI="><script defer src=https://tfsaggregator.github.io/en.search.min.3de2b926470eb7ccdea4c0da493b0bbf812c562da8681079c62116de5daf5619.js integrity="sha256-PeK5JkcOt8zepMDaSTsLv4EsVi2oaBB5xiEW3l2vVhk="></script></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=https://tfsaggregator.github.io/><span>Aggregator</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://tfsaggregator.github.io/docs/v3/>Aggregator 3 (CLI)</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/>Setup</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azdo-authn/>Azure DevOps Personal Access Token</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azure/>Azure CLI Setup</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/docker/>Docker configuration</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/production/>Production on Azure</a><ul></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/>CLI Commands</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/commands/common-options/>Common options</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/authentication-commands/>Authentication commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/instance-commands/>Instance commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/rule-commands/>Rule commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/map-commands/>Mapping commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/info-commands/>Informational commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/command-examples/>Examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/>Rules</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/rules/directives/>Directives</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/workitem/>WorkItem event objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/common-rule-objects/>Common objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-basic/>Basic examples</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-advanced/ class=active>Advanced examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/>Design</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/design/caveat/>Caveats</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/parallelism/>Parallelism</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/api/>REST API</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/troubleshoot/>Troubleshoot</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/>Contribute</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/pipelines/>Pipelines</a></li></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/>TFS Aggregator v2</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/intro/ class=collapsed>Introduction</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/ class=collapsed>Users' Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/ class=collapsed>Administrator Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/ class=collapsed>Contributing</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/changelog/>Changelog</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=https://tfsaggregator.github.io/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Advanced examples</strong>
<label for=toc-control><img src=https://tfsaggregator.github.io/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#backlog-work-items-auto-activate-parent>Backlog work items: Auto-activate parent</a></li><li><a href=#backlog-work-items-auto-resolve-parent>Backlog work items: Auto-Resolve parent</a></li></ul></nav></aside></header><article class=markdown><h1 id=advanced-rule-examples>Advanced Rule examples
<a class=anchor href=#advanced-rule-examples>#</a></h1><h2 id=backlog-work-items-auto-activate-parent>Backlog work items: Auto-activate parent
<a class=anchor href=#backlog-work-items-auto-activate-parent>#</a></h2><p>This is a more advanced version which has no hard coded work item type names.
It moves a parent work item to active state (activates parent), if a child gets activated and both parent and child are backlog work items</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>//Method to check if a &#39;workItem&#39; is in a &#39;Progress&#39; state
</span><span style=color:#75715e></span><span style=color:#66d9ef>bool</span> IsInProgress(WorkItemWrapper workItem, BacklogWorkItemTypeStates workItemType)
{
    <span style=color:#66d9ef>var</span> concreteStateNames = workItemType?.StateCategoryStateNames
                                            .Where(category =&gt; <span style=color:#66d9ef>string</span>.Equals(<span style=color:#e6db74>&#34;InProgress&#34;</span>, category.Key, StringComparison.OrdinalIgnoreCase))
                                            .SelectMany(category =&gt; category.Value);

    <span style=color:#66d9ef>return</span> concreteStateNames?.Contains(workItem.State) ?? <span style=color:#66d9ef>false</span>;
}

<span style=color:#75715e>// First simple check if there is a parent
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> parentWorkItem = self.Parent;
<span style=color:#66d9ef>if</span> (parentWorkItem == <span style=color:#66d9ef>null</span>)
{
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;No Parent&#34;</span>;
}

<span style=color:#75715e>// now get the backlog work item types with their state to category mapping
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> backlogWorkItems = <span style=color:#66d9ef>await</span> store.GetBacklogWorkItemTypesAndStates();
<span style=color:#66d9ef>var</span> backlogWorkItemsLookup = backlogWorkItems.ToDictionary(itemType =&gt; itemType.Name, itemType =&gt; itemType);

<span style=color:#75715e>// Check if we are a back log work item and we are in an InProgress state
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> workItemType = backlogWorkItemsLookup.GetValueOrDefault(self.WorkItemType);
<span style=color:#66d9ef>if</span> (!IsInProgress(self, workItemType))
{
    <span style=color:#66d9ef>return</span> workItemType == <span style=color:#66d9ef>null</span> ? <span style=color:#e6db74>&#34;No Backlog work item type&#34;</span> : <span style=color:#e6db74>$&#34;work item not &lt;InProgress&gt; (State={self.State})&#34;</span>;
}

<span style=color:#75715e>// Check if parent already in progress state and a back log work
</span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> parentWorkItemType = backlogWorkItemsLookup.GetValueOrDefault(parentWorkItem.WorkItemType);
<span style=color:#66d9ef>if</span> (IsInProgress(parentWorkItem, parentWorkItemType))
{
    <span style=color:#66d9ef>return</span> parentWorkItemType == <span style=color:#66d9ef>null</span> ? <span style=color:#e6db74>&#34;No Backlog work item type&#34;</span> : <span style=color:#e6db74>$&#34;work item already &lt;InProgress&gt; (State={parentWorkItem.State})&#34;</span>;
}

<span style=color:#75715e>// Now set the parent to a state of the InProgress category
</span><span style=color:#75715e></span>parentWorkItem.State = parentWorkItemType.StateCategoryStateNames[<span style=color:#e6db74>&#34;InProgress&#34;</span>].First();
<span style=color:#66d9ef>return</span> <span style=color:#e6db74>$&#34;updated Parent {parentWorkItem.WorkItemType} #{parentWorkItem.Id} to State=&#39;{parentWorkItem.State}&#39;&#34;</span>;
</code></pre></div><h2 id=backlog-work-items-auto-resolve-parent>Backlog work items: Auto-Resolve parent
<a class=anchor href=#backlog-work-items-auto-resolve-parent>#</a></h2><p>This is more similar to classic TFS Aggregator.
It moves a parent backlog work item to Resolved state, if all children are closed or terminated.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#75715e>//base method to check state
</span><span style=color:#75715e></span><span style=color:#66d9ef>bool</span> IsBacklogWorkItemInState(WorkItemWrapper workItem, BacklogWorkItemTypeStates workItemType, IEnumerable&lt;<span style=color:#66d9ef>string</span>&gt; expectedStateCategories)
{
    <span style=color:#66d9ef>bool</span> IsInExpectedStateCategory(KeyValuePair&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>string</span>[]&gt; category)
    {
        <span style=color:#66d9ef>return</span> expectedStateCategories.Any(expectedStateCategroy =&gt; <span style=color:#66d9ef>string</span>.Equals(expectedStateCategroy, category.Key, StringComparison.OrdinalIgnoreCase));
    }

    <span style=color:#66d9ef>var</span> concreteStateNames = workItemType?.StateCategoryStateNames
                                            .Where(IsInExpectedStateCategory)
                                            .SelectMany(category =&gt; category.Value);


    <span style=color:#66d9ef>return</span> concreteStateNames?.Contains(workItem.State) ?? <span style=color:#66d9ef>false</span>;
}

<span style=color:#75715e>//Method to check if a &#39;workItem&#39; is in a &#39;Removed&#39; or &#39;Completed&#39; state
</span><span style=color:#75715e></span><span style=color:#66d9ef>bool</span> IsRemovedOrCompleted(WorkItemWrapper workItem, BacklogWorkItemTypeStates workItemType)
{
    <span style=color:#66d9ef>var</span> expectedStateCategories = <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>string</span>[]
                                {
                                    <span style=color:#e6db74>&#34;Completed&#34;</span>,
                                    <span style=color:#e6db74>&#34;Removed&#34;</span>,
                                };

    <span style=color:#66d9ef>return</span> IsBacklogWorkItemInState(workItem, workItemType, expectedStateCategories);
}


<span style=color:#66d9ef>var</span> parentWorkItem = self.Parent;
<span style=color:#66d9ef>if</span> (parentWorkItem == <span style=color:#66d9ef>null</span>)
{
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;No Parent&#34;</span>;
}

<span style=color:#66d9ef>var</span> backlogWorkItems = <span style=color:#66d9ef>await</span> store.GetBacklogWorkItemTypesAndStates();
<span style=color:#66d9ef>var</span> backlogWorkItemsLookup = backlogWorkItems.ToDictionary(itemType =&gt; itemType.Name, itemType =&gt; itemType);

<span style=color:#66d9ef>var</span> workItemType = backlogWorkItemsLookup.GetValueOrDefault(self.WorkItemType);
<span style=color:#66d9ef>if</span> (!IsRemovedOrCompleted(self, workItemType))
{
    <span style=color:#66d9ef>return</span> workItemType == <span style=color:#66d9ef>null</span> ? <span style=color:#e6db74>&#34;No Backlog work item type&#34;</span> : <span style=color:#e6db74>$&#34;work item not &lt;Removed&gt; or &lt;Completed&gt; (State={self.State})&#34;</span>;
}

<span style=color:#66d9ef>var</span> parentWorkItemType = backlogWorkItemsLookup.GetValueOrDefault(parentWorkItem.WorkItemType);
<span style=color:#66d9ef>if</span> (IsRemovedOrCompleted(parentWorkItem, parentWorkItemType))
{
    <span style=color:#66d9ef>return</span> parentWorkItem == <span style=color:#66d9ef>null</span> ? <span style=color:#e6db74>&#34;No Backlog work item type&#34;</span> : <span style=color:#e6db74>$&#34;work item already &lt;Removed&gt; or &lt;Completed&gt; (State={parentWorkItem.State})&#34;</span>;
}

<span style=color:#66d9ef>if</span> (!parentWorkItem.Children.All(item =&gt; IsRemovedOrCompleted(item, backlogWorkItemsLookup.GetValueOrDefault(item.WorkItemType))))
{
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>$&#34;Not all child work items &lt;Removed&gt; or &lt;Completed&gt;: {string.Join(&#34;</span>,<span style=color:#e6db74>&#34;, parentWorkItem.Children.Select(item =&gt; $&#34;</span><span style=color:#960050;background-color:#1e0010>#</span>{item.Id}={item.State}<span style=color:#e6db74>&#34;))}&#34;</span>;
}

<span style=color:#66d9ef>var</span> progressStates = parentWorkItemType.StateCategoryStateNames[<span style=color:#e6db74>&#34;InProgress&#34;</span>];
parentWorkItem.State = progressStates.Last();
<span style=color:#66d9ef>return</span> <span style=color:#e6db74>$&#34;updated Parent #{parentWorkItem.Id} to State=&#39;{parentWorkItem.State}&#39;&#34;</span>;
</code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/commit/9bca3817d4005b62d252d0757f43f4ef7644a8e4 title="Last modified by Jesse Houwing | August 10, 2022" target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/calendar.svg class=book-icon alt=Calendar>
<span>August 10, 2022</span></a></div><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/edit/master/content//docs/v3/rules/rule-examples-advanced.md target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#backlog-work-items-auto-activate-parent>Backlog work items: Auto-activate parent</a></li><li><a href=#backlog-work-items-auto-resolve-parent>Backlog work items: Auto-Resolve parent</a></li></ul></nav></aside></main></body></html>