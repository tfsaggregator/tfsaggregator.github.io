<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Build and deploy #  The ci.yml pipeline is encompassing all steps required to publish all Aggregator components. This build is triggered by any push of commits or tags as long as they touch the /src/ directory or a workflow.
Some steps and jobs runs only for a tag starting with v, others when the build is run on the default master branch: you see a label v or m or both aside each conditional phase."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Pipelines"><meta property="og:description" content="Build and deploy #  The ci.yml pipeline is encompassing all steps required to publish all Aggregator components. This build is triggered by any push of commits or tags as long as they touch the /src/ directory or a workflow.
Some steps and jobs runs only for a tag starting with v, others when the build is run on the default master branch: you see a label v or m or both aside each conditional phase."><meta property="og:type" content="article"><meta property="og:url" content="https://tfsaggregator.github.io/docs/v3/contrib/pipelines/"><meta property="article:modified_time" content="2020-09-09T21:01:37+02:00"><title>Pipelines | Aggregator</title><link rel=manifest href=https://tfsaggregator.github.io/manifest.json><link rel=icon href=https://tfsaggregator.github.io/favicon.png type=image/x-icon><link rel=stylesheet href=https://tfsaggregator.github.io/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI="><script defer src=https://tfsaggregator.github.io/en.search.min.f87f40e91be499e9efec3daa22ad8c4d34b8fd64e2b8dbc94b9769b96363f90a.js integrity="sha256-+H9A6Rvkmenv7D2qIq2MTTS4/WTiuNvJS5dpuWNj+Qo="></script></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=https://tfsaggregator.github.io/><span>Aggregator</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://tfsaggregator.github.io/docs/v3/>Aggregator 3 (CLI)</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/>Setup</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azdo-authn/>Azure DevOps Personal Access Token</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azure/>Azure CLI Setup</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/production/>Azure Production</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/docker/>Docker configuration</a><ul></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/>CLI Commands</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/commands/common-options/>Common options</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/authentication-commands/>Authentication commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/instance-commands/>Instance commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/rule-commands/>Rule commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/map-commands/>Mapping commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/info-commands/>Informational commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/command-examples/>Examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/>Rules</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/rules/directives/>Directives</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/workitem/>WorkItem event objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/common-rule-objects/>Common objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-basic/>Basic examples</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-advanced/>Advanced examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/>Design</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/design/parallelism/>Parallelism</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/api/>REST API</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/>Contribute</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/pipelines/ class=active>Pipelines</a></li></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/>TFS Aggregator v2</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/intro/ class=collapsed>Introduction</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/ class=collapsed>Users' Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/ class=collapsed>Administrator Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/ class=collapsed>Contributing</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/changelog/>Changelog</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=https://tfsaggregator.github.io/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Pipelines</strong>
<label for=toc-control><img src=https://tfsaggregator.github.io/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#build-and-deploy>Build and deploy</a><ul><li><a href=#build>Build</a></li><li><a href=#unit-tests>Unit tests</a></li><li><a href=#integration-tests-vm>Integration tests [vm]</a></li><li><a href=#sonarqube-vm>SonarQube [vm]</a></li><li><a href=#package-v>Package [v]</a></li><li><a href=#draft-github-release-v>Draft GitHub Release [v]</a></li><li><a href=#docker-build>Docker build</a></li><li><a href=#docker-push>Docker push</a></li></ul></li><li><a href=#visual-studio-marketplace>Visual Studio Marketplace</a></li><li><a href=#twitter>Twitter</a></li><li><a href=#documentation>Documentation</a></li></ul></nav></aside></header><article class=markdown><h2 id=build-and-deploy>Build and deploy
<a class=anchor href=#build-and-deploy>#</a></h2><p>The <code>ci.yml</code> pipeline is encompassing all steps required to publish all Aggregator components. This build is triggered by any push of commits or tags as long as they touch the <code>/src/</code> directory or a workflow.</p><p>Some steps and jobs runs only for a tag starting with <code>v</code>, others when the build is run on the default master branch: you see a label <code>v</code> or <code>m</code> or both aside each conditional phase.</p><p>Steps can leverage <a href=https://docs.microsoft.com/en-us/dotnet/core/tools/local-tools-how-to-use>dotnet local tools</a>. Currently we use:</p><ul><li>sonarscanner</li><li>coverlet</li><li>reportgenerator</li></ul><p>To ensure cross-platform portability, almost every build step is executed on Linux (<code>ubuntu-latest</code> GitHub environment) to counterbalance Windows development.
The only step on Windows builds the Docker Image for Windows.</p><h3 id=build>Build
<a class=anchor href=#build>#</a></h3><p>The whole <code>/src/aggregator-cli.sln</code> is built and restored.
Build configuration is <code>Release</code>.
Assembly version is GitVersion majorMinorPatch and preReleaseTag.</p><h3 id=unit-tests>Unit tests
<a class=anchor href=#unit-tests>#</a></h3><p>Unit tests use <code>/src/unittests-*</code> projects and include Code Coverage via coverlet.
Test data is included in Sonar analysis.</p><h3 id=integration-tests-vm>Integration tests [vm]
<a class=anchor href=#integration-tests-vm>#</a></h3><p>Integration tests will create resources in our Azure Subscription.
They use a <code>logon-data.json</code> file defining the Azure Resource Group, the Azure DevOps Project, and credentials to access them.
The file content is pulled from GitHub Secrets and removed when done.</p><h3 id=sonarqube-vm>SonarQube [vm]
<a class=anchor href=#sonarqube-vm>#</a></h3><p>The build runs an initial PowerShell script at its start, to assure that all <code>.csproj</code> have a valid <code>ProjectGuid</code> property.
This hack is still required by Sonarcube scanner.
The scanner collects all test results and code coverage data.
For convenience the code coverage information is available as HTML pages in the build artifacts thanks to ReportGenerator.</p><h3 id=package-v>Package [v]
<a class=anchor href=#package-v>#</a></h3><p>The binaries for the Function Runtime and the CLI (in three OS flavor) are collected, zipped and uploaded as artifacts for later publishing.</p><h3 id=draft-github-release-v>Draft GitHub Release [v]
<a class=anchor href=#draft-github-release-v>#</a></h3><p>Packaged Artifacts are downloaded and their hash computed.
A new draft Release is created with the artifacts and description from <code>Next-Release-ChangeLog.md</code>.
The Release may need additional editing before publishing.
When the draft is published, additional workflows will trigger.</p><h3 id=docker-build>Docker build
<a class=anchor href=#docker-build>#</a></h3><p>Docker builds the two <code>/docker/linux-x64.Dockerfile</code> and <code>/docker/win-x64.Dockerfile</code> using the entire repo as context (there are some odd dependencies).
The workflow defines two build arguments <code>MAJOR_MINOR_PATCH</code> and <code>PRERELEASE_TAG</code>.
The set of tests in <code>unittests-function.csproj</code> is not run.
The tags used for the images are uploaded as build artifacts.</p><h3 id=docker-push>Docker push
<a class=anchor href=#docker-push>#</a></h3><p>Creates a docker manifest (aka <a href=https://docs.docker.com/engine/reference/commandline/manifest/>manifest lists</a>) to include both the Windows and Linux image under a single tag and generates the <strong>lastest</strong> image.
It uses the tags generated in the previous step.
Finally, the README is published using a jinja2 transformation.</p><h2 id=visual-studio-marketplace>Visual Studio Marketplace
<a class=anchor href=#visual-studio-marketplace>#</a></h2><p>This workflow is triggered by the Publishing of the new GitHub Release.</p><p>Uses the <code>tfx</code> (aka <em>TFS Cross Platform Command Line Interface</em>) to refresh the <a href="https://marketplace.visualstudio.com/items?itemName=tfsaggregatorteam.aggregator-cli">Visual Studio Marketplace</a> page for Aggregator using the content of the <code>/marketplace</code> directory.</p><h2 id=twitter>Twitter
<a class=anchor href=#twitter>#</a></h2><p>This workflow is triggered by the Publishing of the new GitHub Release.</p><p>Use an Action to advertise on <a href=https://twitter.com/tfsaggregator>Twitter</a> the availability of the new release.</p><h2 id=documentation>Documentation
<a class=anchor href=#documentation>#</a></h2><p>This workflow (<code>publish-on-master.yml</code>) is used to validate pull requests and publish when merged on the default master branch.</p><p>It uses Hugo and the hugo-book theme to generate the site, which is then published via GitHub Pages on a different repository.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/commit/098469e01d514333e4ae4cbf908e196698d2fedd title="Last modified by Giulio Vian | September 9, 2020" target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/calendar.svg class=book-icon alt=Calendar>
<span>September 9, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/edit/master/content//docs/v3/contrib/pipelines.md target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#build-and-deploy>Build and deploy</a><ul><li><a href=#build>Build</a></li><li><a href=#unit-tests>Unit tests</a></li><li><a href=#integration-tests-vm>Integration tests [vm]</a></li><li><a href=#sonarqube-vm>SonarQube [vm]</a></li><li><a href=#package-v>Package [v]</a></li><li><a href=#draft-github-release-v>Draft GitHub Release [v]</a></li><li><a href=#docker-build>Docker build</a></li><li><a href=#docker-push>Docker push</a></li></ul></li><li><a href=#visual-studio-marketplace>Visual Studio Marketplace</a></li><li><a href=#twitter>Twitter</a></li><li><a href=#documentation>Documentation</a></li></ul></nav></aside></main></body></html>