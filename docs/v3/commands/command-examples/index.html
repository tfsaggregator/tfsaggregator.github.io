<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sample Aggregator CLI usage #  This page will show you increasing complex examples of using Aggregator CLI.
To run Aggregator CLI type aggregator-cli.exe on Windows, ./aggregator-cli on Linux or dotnet aggregator-cli.dll on any followed by the command and options. In the examples, we will use aggregator-cli. In PowerShell you can define an alias to exactly match the examples:
Set-Alias aggregator-cli (Resolve-Path .\aggregator-cli.exe)  IMPORTANT: Please avoid naïve copy&paste of the examples, or other user will not be able to run the same."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Examples"><meta property="og:description" content="Sample Aggregator CLI usage #  This page will show you increasing complex examples of using Aggregator CLI.
To run Aggregator CLI type aggregator-cli.exe on Windows, ./aggregator-cli on Linux or dotnet aggregator-cli.dll on any followed by the command and options. In the examples, we will use aggregator-cli. In PowerShell you can define an alias to exactly match the examples:
Set-Alias aggregator-cli (Resolve-Path .\aggregator-cli.exe)  IMPORTANT: Please avoid naïve copy&paste of the examples, or other user will not be able to run the same."><meta property="og:type" content="article"><meta property="og:url" content="https://tfsaggregator.github.io/docs/v3/commands/command-examples/"><meta property="article:modified_time" content="2021-06-12T13:16:19+01:00"><title>Examples | Aggregator</title><link rel=manifest href=https://tfsaggregator.github.io/manifest.json><link rel=icon href=https://tfsaggregator.github.io/favicon.png type=image/x-icon><link rel=stylesheet href=https://tfsaggregator.github.io/book.min.b3215d9d1d18d9051e7fbe8f256ff80e30f41d29073b86348e230d297b771002.css integrity="sha256-syFdnR0Y2QUef76PJW/4DjD0HSkHO4Y0jiMNKXt3EAI="><script defer src=https://tfsaggregator.github.io/en.search.min.806e3d96617265ba96a1af820c08377d4d27e6c76a6e546a9be44435f1a18d01.js integrity="sha256-gG49lmFyZbqWoa+CDAg3fU0n5sdqblRqm+RENfGhjQE="></script></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=https://tfsaggregator.github.io/><span>Aggregator</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://tfsaggregator.github.io/docs/v3/>Aggregator 3 (CLI)</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/>Setup</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azdo-authn/>Azure DevOps Personal Access Token</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/azure/>Azure CLI Setup</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/docker/>Docker configuration</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/setup/production/>Production on Azure</a><ul></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/>CLI Commands</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/commands/common-options/>Common options</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/authentication-commands/>Authentication commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/instance-commands/>Instance commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/rule-commands/>Rule commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/map-commands/>Mapping commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/info-commands/>Informational commands</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/commands/command-examples/ class=active>Examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/>Rules</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/rules/directives/>Directives</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/workitem/>WorkItem event objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/common-rule-objects/>Common objects</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-basic/>Basic examples</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/rules/rule-examples-advanced/>Advanced examples</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/>Design</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/design/caveat/>Caveats</a></li><li><a href=https://tfsaggregator.github.io/docs/v3/design/parallelism/>Parallelism</a></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/api/>REST API</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/troubleshoot/>Troubleshoot</a><ul></ul></li><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/>Contribute</a><ul><li><a href=https://tfsaggregator.github.io/docs/v3/contrib/pipelines/>Pipelines</a></li></ul></li></ul></li><li><a href=https://tfsaggregator.github.io/docs/v2/>TFS Aggregator v2</a><ul><li><a href=https://tfsaggregator.github.io/docs/v2/intro/ class=collapsed>Introduction</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/using/ class=collapsed>Users' Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/admin/ class=collapsed>Administrator Guide</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/contrib/ class=collapsed>Contributing</a></li><li><a href=https://tfsaggregator.github.io/docs/v2/changelog/>Changelog</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=https://tfsaggregator.github.io/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Examples</strong>
<label for=toc-control><img src=https://tfsaggregator.github.io/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#basic-example>Basic example</a><ul><li><a href=#logon-basic>Logon (basic)</a></li><li><a href=#create-the-aggregator-instance-basic>Create the Aggregator Instance (basic)</a></li><li><a href=#confirm-that-the-aggregator-instance-is-accessible-basic>Confirm that the Aggregator Instance is accessible (basic)</a></li><li><a href=#add-two-aggregator-rules-basic>Add two Aggregator Rules (basic)</a></li><li><a href=#tell-azure-devops-to-call-the-rules-basic>Tell Azure DevOps to call the Rules (basic)</a></li><li><a href=#clean-up-basic>Clean up (basic)</a></li></ul></li><li><a href=#intermediate-example>Intermediate example</a><ul><li><a href=#logon-intermediate>Logon (intermediate)</a></li><li><a href=#create-the-aggregator-instance-intermediate>Create the Aggregator Instance (intermediate)</a></li><li><a href=#add-aggregator-rules-intermediate>Add Aggregator Rules (intermediate)</a></li><li><a href=#tell-azure-devops-to-call-the-rules-intermediate>Tell Azure DevOps to call the Rules (intermediate)</a></li><li><a href=#clean-up-intermediate>Clean up (intermediate)</a></li></ul></li><li><a href=#advanced-example>Advanced example</a><ul><li><a href=#logon-advanced>Logon (advanced)</a></li><li><a href=#create-the-aggregator-instance-advanced>Create the Aggregator Instance (advanced)</a></li><li><a href=#add-an-aggregator-rule-advanced>Add an Aggregator Rule (advanced)</a></li><li><a href=#tell-azure-devops-to-call-the-rule-advanced>Tell Azure DevOps to call the Rule (advanced)</a></li><li><a href=#execute-impersonated>Execute Impersonated</a></li><li><a href=#updating-a-rule>Updating a Rule</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=sample-aggregator-cli-usage>Sample Aggregator CLI usage
<a class=anchor href=#sample-aggregator-cli-usage>#</a></h1><p>This page will show you increasing complex examples of using Aggregator CLI.</p><p>To run Aggregator CLI type <code>aggregator-cli.exe</code> on Windows, <code>./aggregator-cli</code> on Linux or <code>dotnet aggregator-cli.dll</code> on any followed by the command and options.
In the examples, we will use <code>aggregator-cli</code>. In PowerShell you can define an alias to exactly match the examples:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1>Set-Alias aggregator-cli (Resolve-Path .\aggregator-cli.exe)
</code></pre></div><blockquote><p>IMPORTANT: Please avoid naïve copy&paste of the examples, or other user will not be able to run the same. Instance names cannot be duplicated in Azure! At least, delete the Azure Resources, after testing the examples.</p></blockquote><p>Study all three scenarios and try some of the sample commands to make yourself comfortable with Aggregator.</p><h2 id=basic-example>Basic example
<a class=anchor href=#basic-example>#</a></h2><p>This example shows the basic steps to write and deploy Aggregator Rules.
It not intended to represent a more realistic, enterprise-oriented scenario like the <a href=#intermediate-example>Intermediate</a> and the <a href=#advanced-example>Advanced</a> examples.</p><p>This example assumes that the Azure account has Contributor permission on the whole Azure Subscription and also to an Azure DevOps Project.</p><h3 id=logon-basic>Logon (basic)
<a class=anchor href=#logon-basic>#</a></h3><p>You are required to log into both Azure and ADO. The credentials are cached locally and expire after 2 hours. <em>(Replace the below asterisks <code>*</code> with valid values.)</em></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli logon.azure --subscription ************ --client ************ --password *********** --tenant ************
aggregator-cli logon.ado --url https://dev.azure.com/youraccount --mode PAT --token ***************************************
</code></pre></div><h3 id=create-the-aggregator-instance-basic>Create the Aggregator Instance (basic)
<a class=anchor href=#create-the-aggregator-instance-basic>#</a></h3><p>The Aggregator Instance is an Azure Function Application plus the Aggregator Runtime that execute the Rules.</p><p>The next snippet creates a new instance &ndash; and a new Azure Resource Group &ndash; in the West Europe region.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli install.instance --verbose --name inst1 --location westeurope
</code></pre></div><p>Note:</p><ul><li>The Aggregator instance name must be unique in Azure (CLI automatically appends <code>aggregator</code> suffix to minimize the chance of a clash, unless you override using a <a href=../instance-commands/#azure-resource-names>Naming Template</a>).</li><li>You can specify the version of Aggregator Runtime using the <code>requiredVersion</code> option. Look in <a href=https://github.com/tfsaggregator/aggregator-cli/releases>our releases</a> for valid version numbers.</li><li>You can use the <a href=https://github.com/Azure/azure-cli>Azure CLI</a> to get the list of Azure Regions: <code>az account list-locations -o table</code>.</li><li>This is the slowest command: it typically takes a few minutes to create the resources in Azure and upload Aggregator Runtime.</li></ul><h3 id=confirm-that-the-aggregator-instance-is-accessible-basic>Confirm that the Aggregator Instance is accessible (basic)
<a class=anchor href=#confirm-that-the-aggregator-instance-is-accessible-basic>#</a></h3><p>The next command searches the entire Azure Subscription (previously connected to via logon.azure):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli list.instances
</code></pre></div><p>It should list <code>inst1</code>.</p><h3 id=add-two-aggregator-rules-basic>Add two Aggregator Rules (basic)
<a class=anchor href=#add-two-aggregator-rules-basic>#</a></h3><p>The Aggregator Rule is a special kind of Azure Function.</p><p>Write a text file named <code>hello.rule</code> with this content:</p><pre><code>$&quot;Hello { self.WorkItemType } #{ self.Id } - { self.Title }!&quot;
</code></pre><p>Check if the Rule is correct, by running the code locally.
Note that the <em>SampleProject</em> must exists in Azure DevOps while the WorkItem with ID <code>14</code> is fake. You can use a different project name.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli invoke.rule --dryrun --project SampleProject --event workitem.created --workItemId 14 --local --source hello.rule
</code></pre></div><p>Note that the <code>--source</code> parameter is a local file relative to the working directory.
Even if you skip the above step, the <code>add.rule</code> command will validate the syntax of the code before uploading.</p><p>The next snippet adds two rules where the file parameter is a local file relative to the working directory.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli add.rule --verbose --instance inst1 --name hello --file hello.rule
aggregator-cli list.rules --verbose --instance inst1
</code></pre></div><p>The last command should output</p><pre><code>Rule inst1/hello
</code></pre><p>Write a second text file named <code>close_parent.rule</code> with this content</p><pre><code>string message = &quot;&quot;;
if (self.Parent != null)
{
    var parent = self.Parent;
    var children = parent.Children;
    if (children.All(c =&gt; c.State == &quot;Closed&quot;))
    {
        parent.State = &quot;Closed&quot;;
        message = &quot;Parent was closed&quot;;
    }
    else
    {
        message = &quot;Parent was already closed&quot;;
    }
    parent.Description = parent.Description + &quot; aggregator was here.&quot;;
}
return message;
</code></pre><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli add.rule --verbose --instance inst1 --name parent --file close_parent.rule
aggregator-cli list.rules --verbose --instance inst1
</code></pre></div><p>You may have noted that the name of the Rule can be different from the file name.</p><h3 id=tell-azure-devops-to-call-the-rules-basic>Tell Azure DevOps to call the Rules (basic)
<a class=anchor href=#tell-azure-devops-to-call-the-rules-basic>#</a></h3><p>The next commands will add two service hooks to Azure DevOps, each invoking a different Rule, the one we added before.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli map.rule --verbose --project SampleProject --event workitem.created --instance inst1 --rule hello
aggregator-cli map.rule --verbose --project SampleProject --event workitem.updated --instance inst1 --rule parent
</code></pre></div><p>The same rule can be triggered by multiple events from different Azure DevOps projects. Currently only these events are supported:<br><code>workitem.created</code><br><code>workitem.updated</code><br><code>workitem.deleted</code><br><code>workitem.restored</code><br><code>workitem.commented</code></p><p>The list commands below should give the same results. Note the various options for restricting the search.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli list.mappings --verbose --instance inst1
aggregator-cli list.mappings --verbose --project SampleProject
aggregator-cli list.mappings --instance inst1 --project SampleProject
</code></pre></div><h3 id=clean-up-basic>Clean up (basic)
<a class=anchor href=#clean-up-basic>#</a></h3><p>The first command will delete the Azure Function App and all the webhooks in Azure DevOps.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli uninstall.instance --name inst1 --location westeurope
aggregator-cli logoff
</code></pre></div><h2 id=intermediate-example>Intermediate example
<a class=anchor href=#intermediate-example>#</a></h2><p>This scenario is a middle ground between the Basic and the more Advanced. It is suitable for most cases, including production deployment and automation.
It still goes through the four basic configuration steps:</p><ol><li><a href=#logon-intermediate>Logon</a></li><li><a href=#create-the-aggregator-instance-intermediate>Create the Aggregator Instance</a></li><li><a href=#add-aggregator-rules-intermediate>Add two Aggregator Rules</a></li><li><a href=#tell-azure-devops-to-call-the-rules-intermediate>Tell Azure DevOps to call the Rules</a></li></ol><p>This example assumes that an Azure Resource Group named <code>myRG1</code> already exists and the Azure account has Contributor permission on it and also to an Azure DevOps Project.
Create an Azure DevOps Project name <em>SampleProject</em>. It must use a custom template, <em>Custom Agile</em> in the screenshots, but you can use a different name.</p><p><img src=../new-sampleproject.png alt="<em>SampleProject</em> using <em>Custom Agile</em> template"></p><p>Add a custom field to template Task.</p><p><img src=../add-new-field.png alt="Add a new custom field"></p><p>and name the new field <code>CustomText</code>.</p><p><img src=../new-field-definition.png alt="Name the new field <code>CustomText</code>">.</p><h3 id=logon-intermediate>Logon (intermediate)
<a class=anchor href=#logon-intermediate>#</a></h3><p>You are required to log into both Azure and ADO. We recommend using <code>logon.env</code> to define credentials data in environment variables.</p><p>Using PowerShell (<em>Replace the below asterisks <code>*</code> with valid values.</em>):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell>$env:AGGREGATOR_SUBSCRIPTIONID = <span style=color:#e6db74>&#39;************&#39;</span>
$env:AGGREGATOR_TENANTID = <span style=color:#e6db74>&#39;************&#39;</span>
$env:AGGREGATOR_CLIENTID = <span style=color:#e6db74>&#39;************&#39;</span>
$env:AGGREGATOR_CLIENTSECRET = <span style=color:#e6db74>&#39;************&#39;</span>
$env:AGGREGATOR_AZDO_URL = <span style=color:#e6db74>&#34;https://dev.azure.com/********&#34;</span>
$env:AGGREGATOR_AZDO_MODE = <span style=color:#e6db74>&#39;PAT&#39;</span>
$env:AGGREGATOR_AZDO_TOKEN = <span style=color:#e6db74>&#39;***************************************&#39;</span>
aggregator-cli logon.env --verbose
</code></pre></div><p>Using bash (<em>Replace the below asterisks <code>*</code> with valid values.</em>):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>export AGGREGATOR_SUBSCRIPTIONID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;************&#39;</span>
export AGGREGATOR_TENANTID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;************&#39;</span>
export AGGREGATOR_CLIENTID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;************&#39;</span>
export AGGREGATOR_CLIENTSECRET <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;************&#39;</span>
export AGGREGATOR_AZDO_URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://dev.azure.com/********&#34;</span>
export AGGREGATOR_AZDO_MODE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PAT&#39;</span>
export AGGREGATOR_AZDO_TOKEN <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;***************************************&#39;</span>
aggregator-cli logon.env --verbose
</code></pre></div><p>The credentials are cached locally and expire after 2 hours.
This approach works well in automation scenarios.</p><h3 id=create-the-aggregator-instance-intermediate>Create the Aggregator Instance (intermediate)
<a class=anchor href=#create-the-aggregator-instance-intermediate>#</a></h3><p>The next snippet creates a new Aggregator Instance on an existing Resource Group named <code>myRG1</code> in the West Europe region using a specific Runtime version available in GitHub.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli install.instance --name inst2 --resourceGroup myRG1 --location westeurope --requiredVersion 0.9.14
</code></pre></div><p>If you cannot access GitHub, you can download the runtime on a local folder and point to it explicitly.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli install.instance --name inst2 --resourceGroup myRG1 --location westeurope --sourceUrl file://C:/temp/FunctionRuntime.zip
</code></pre></div><p>Now, check that the instance is there as expected.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli list.instances --resourceGroup myRG1
</code></pre></div><p>An instance is enough for most purposes, we will see in the next section how to manage alternative version of the Rules. In the <a href=#advanced-example>Advanced scenario</a> we will look at using more than one instance and why.</p><h3 id=add-aggregator-rules-intermediate>Add Aggregator Rules (intermediate)
<a class=anchor href=#add-aggregator-rules-intermediate>#</a></h3><p>Again write a text file named <code>hello.rule</code> with this content:</p><pre><code>$&quot;Hello { self.WorkItemType } #{ self.Id } - { self.Title }!&quot;
</code></pre><p>Check if the Rule is correct, by running the code locally.
Note that the <em>SampleProject</em> must exists in Azure DevOps, if it doesn&rsquo;t please use the name of an existing Project.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli invoke.rule --dryrun --project SampleProject --event workitem.created --workItemId 14 --local --source hello.rule
</code></pre></div><p>Now, we add the same rule twice with different names. This techniques is a simple way to test alternative versions of a Rule.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli add.rule --verbose --instance inst2 --resourceGroup myRG1 --name hello --file hello.rule
aggregator-cli add.rule --verbose --instance inst2 --resourceGroup myRG1 --name hello-dev --file hello.rule
aggregator-cli list.rules --verbose --instance inst2 --resourceGroup myRG1
</code></pre></div><p>The last command should output</p><pre><code>Rule inst2/hello
Rule inst2/hello-dev
</code></pre><h3 id=tell-azure-devops-to-call-the-rules-intermediate>Tell Azure DevOps to call the Rules (intermediate)
<a class=anchor href=#tell-azure-devops-to-call-the-rules-intermediate>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli map.rule --verbose --project SampleProject --event workitem.updated --instance inst2 --resourceGroup myRG1 --rule hello --filterType Task
aggregator-cli map.rule --verbose --project SampleProject --event workitem.updated --instance inst2 --resourceGroup myRG1 --rule hello-dev --filterType Task --filterFields Custom.CustomText
aggregator-cli configure.rule --verbose --instance inst2 --resourceGroup myRG1 --name hello --disable=true
</code></pre></div><p>Now create a Task, save it and update the <code>CustomText</code> field.
The first webhook will see a 404, because the underlying Azure Function is disabled, while the second should succeed.</p><p><img src=../mix-service-hooks.png alt="Service Hooks"></p><p>The second webhook is used only when the <code>CustomText</code> field changes.</p><p>To reenable e stop any calls to the dev version of the hello Rule:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli configure.rule --verbose --instance inst2 --resourceGroup myRG1 --name hello --enable=true
aggregator-cli unmap.rule --verbose --project SampleProject --event workitem.updated --instance inst2 --resourceGroup myRG1 --rule hello-dev
</code></pre></div><p>Note that you can set less parameter to delete all matching webhooks.</p><h3 id=clean-up-intermediate>Clean up (intermediate)
<a class=anchor href=#clean-up-intermediate>#</a></h3><p>To delete all the object previously created, you simply delete the Instance.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli uninstall.instance --name inst2 --resourceGroup myRG1 --location westeurope
aggregator-cli logoff
</code></pre></div><p>The command will automatically remove any mapping (webhook) in Azure DevOps that use the Instance.</p><blockquote class="book-hint warning"><p><strong>Warning</strong></p><p>Some Azure Resources are not automatically deleted, namely the AppService Plan, the AppInsights instance and the Storage Account. This is deliberate to support audit.</p></blockquote><h2 id=advanced-example>Advanced example
<a class=anchor href=#advanced-example>#</a></h2><p>The last scenario shows how to control the name of Azure Resources &ndash; so you can comply with enterprise policies &ndash; and some additional management techniques.</p><h3 id=logon-advanced>Logon (advanced)
<a class=anchor href=#logon-advanced>#</a></h3><p>Authentication does not change from the <a href=#logon-intermediate>previous example</a>.</p><h3 id=create-the-aggregator-instance-advanced>Create the Aggregator Instance (advanced)
<a class=anchor href=#create-the-aggregator-instance-advanced>#</a></h3><p>Again write a text file named <code>my-naming-template.json</code> with this content:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;ResourceGroupPrefix&#34;</span>: <span style=color:#e6db74>&#34;my&#34;</span>,
  <span style=color:#f92672>&#34;ResourceGroupSuffix&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
  <span style=color:#f92672>&#34;FunctionAppPrefix&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
  <span style=color:#f92672>&#34;FunctionAppSuffix&#34;</span>: <span style=color:#e6db74>&#34;-my&#34;</span>,
  <span style=color:#f92672>&#34;HostingPlanPrefix&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
  <span style=color:#f92672>&#34;HostingPlanSuffix&#34;</span>: <span style=color:#e6db74>&#34;-my-plan&#34;</span>,
  <span style=color:#f92672>&#34;AppInsightPrefix&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
  <span style=color:#f92672>&#34;AppInsightSuffix&#34;</span>: <span style=color:#e6db74>&#34;-my-appinsight&#34;</span>,
  <span style=color:#f92672>&#34;StorageAccountPrefix&#34;</span>: <span style=color:#e6db74>&#34;strg&#34;</span>,
  <span style=color:#f92672>&#34;StorageAccountSuffix&#34;</span>: <span style=color:#e6db74>&#34;12345&#34;</span>
}
</code></pre></div><p>and create the Instance</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli install.instance --name inst3 --resourceGroup RG1 --namingTemplate my-naming-template.json --location westeurope --requiredVersion latest
</code></pre></div><p>You can use a binary store for your artifacts, as long as allows for anonymous download, e.g.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli install.instance --name inst3 --resourceGroup myRG1 --location westeurope --sourceUrl https://artifactory.example.com/artifactory/generic-github-remote/aggregator-cli/v0.9.14/FunctionRuntime.zip
</code></pre></div><p>This is an optional step: create another instance with dedicated resources for production workload. There is no hard-and-fast rule if dedicated is better than dynamic allocation: discuss with your Azure Architect the pros and cons of dedicated resources.</p><blockquote><p>WARNING: The cost profile of dedicated resources is very different.</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli install.instance --name inst4 --resourceGroup RG1 --namingTemplate my-naming-template.json --location westeurope --hostingPlanTier Premium --hostingPlanSku P1V2
</code></pre></div><p>You can see that the resources satisfy the Naming Template.</p><p><img src=../resources-created-using-naming-template.png alt="Resources created using Naming Template"></p><blockquote class="book-hint info">You can scale up or down the compute resources associated with the Plan.</blockquote><h3 id=add-an-aggregator-rule-advanced>Add an Aggregator Rule (advanced)
<a class=anchor href=#add-an-aggregator-rule-advanced>#</a></h3><p>In this example we add a single Rule to serve two events.
Once more, write a new text file named <code>smart-hello.rule</code> with this content:</p><pre><code>if (eventType == &quot;workitem.created&quot;) {
   return $&quot;Hello new { self.WorkItemType } #{ self.Id } - { self.Title }!&quot;;
} else {
   return $&quot;Hi again { self.WorkItemType } #{ self.Id } - { self.Title }!&quot;;
}
</code></pre><p>The next snippet adds two rules where the file parameter is a local file relative to the working directory.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli add.rule --verbose --instance inst3 --resourceGroup RG1 --namingTemplate my-naming-template.json --name smart-hello --file smart-hello.rule
aggregator-cli list.rules --verbose --instance inst3 --resourceGroup RG1 --namingTemplate my-naming-template.json
</code></pre></div><h3 id=tell-azure-devops-to-call-the-rule-advanced>Tell Azure DevOps to call the Rule (advanced)
<a class=anchor href=#tell-azure-devops-to-call-the-rule-advanced>#</a></h3><p>As before, we glue Azure DevOps to the Rules hosted in Azure Functions. Note that both events goes to the same Rule.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli map.rule --verbose --project SampleProject --event workitem.created --instance inst3 --resourceGroup RG1 --namingTemplate my-naming-template.json --rule smart-hello
aggregator-cli map.rule --verbose --project SampleProject --event workitem.updated --instance inst3 --resourceGroup RG1 --namingTemplate my-naming-template.json --rule smart-hello
</code></pre></div><p>Now, if you move to the AppInsight instance associated with the Function and run this Query</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>traces
<span style=color:#f92672>|</span> <span style=color:#66d9ef>where</span> operation_Name<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;smart-hello&#39;</span>
<span style=color:#f92672>|</span> project <span style=color:#66d9ef>timestamp</span>, message
</code></pre></div><p>You can see the traces collected from the Rule.</p><p><img src=../appinsights-logs.png alt="AppInsights logs"></p><h3 id=execute-impersonated>Execute Impersonated
<a class=anchor href=#execute-impersonated>#</a></h3><p>A Rule can use impersonation, that is, instead of authenticating with Azure DevOps as the account who generated the PAT, the Rule can tell Azure DevOps to use the identity of the who generated the event.</p><p><strong>Attention:</strong> To use this feature, the identity accessing Azure DevOps needs special permissions; see <a href=../../setup/#azure-devops-personal-access-token-pat>Rule Examples</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli configure.rule --verbose --instance inst3 --resourceGroup RG1 --namingTemplate my-naming-template.json --name smart-hello --enableImpersonate=true
</code></pre></div><h3 id=updating-a-rule>Updating a Rule
<a class=anchor href=#updating-a-rule>#</a></h3><p>After some time you may want to change a Rule. After testing thoroughly in a development environment, you want to update production with the new version of the Rule.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Batchfile data-lang=Batchfile>aggregator-cli update.rule --verbose --instance inst3 --resourceGroup RG1 --namingTemplate my-naming-template.json --name smart-hello --file smart-hello-v2.rule
</code></pre></div><blockquote class="book-hint warning">Careful: updating a Rule may cause downtime.</p></blockquote></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/commit/98ff02656ce807065814dc5a01315f4e37f024f3 title="Last modified by Giulio Vian | June 12, 2021" target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/calendar.svg class=book-icon alt=Calendar>
<span>June 12, 2021</span></a></div><div><a class="flex align-center" href=https://github.com/tfsaggregator/tfsaggregator-docs-hugo/edit/master/content//docs/v3/commands/command-examples.md target=_blank rel=noopener><img src=https://tfsaggregator.github.io/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#basic-example>Basic example</a><ul><li><a href=#logon-basic>Logon (basic)</a></li><li><a href=#create-the-aggregator-instance-basic>Create the Aggregator Instance (basic)</a></li><li><a href=#confirm-that-the-aggregator-instance-is-accessible-basic>Confirm that the Aggregator Instance is accessible (basic)</a></li><li><a href=#add-two-aggregator-rules-basic>Add two Aggregator Rules (basic)</a></li><li><a href=#tell-azure-devops-to-call-the-rules-basic>Tell Azure DevOps to call the Rules (basic)</a></li><li><a href=#clean-up-basic>Clean up (basic)</a></li></ul></li><li><a href=#intermediate-example>Intermediate example</a><ul><li><a href=#logon-intermediate>Logon (intermediate)</a></li><li><a href=#create-the-aggregator-instance-intermediate>Create the Aggregator Instance (intermediate)</a></li><li><a href=#add-aggregator-rules-intermediate>Add Aggregator Rules (intermediate)</a></li><li><a href=#tell-azure-devops-to-call-the-rules-intermediate>Tell Azure DevOps to call the Rules (intermediate)</a></li><li><a href=#clean-up-intermediate>Clean up (intermediate)</a></li></ul></li><li><a href=#advanced-example>Advanced example</a><ul><li><a href=#logon-advanced>Logon (advanced)</a></li><li><a href=#create-the-aggregator-instance-advanced>Create the Aggregator Instance (advanced)</a></li><li><a href=#add-an-aggregator-rule-advanced>Add an Aggregator Rule (advanced)</a></li><li><a href=#tell-azure-devops-to-call-the-rule-advanced>Tell Azure DevOps to call the Rule (advanced)</a></li><li><a href=#execute-impersonated>Execute Impersonated</a></li><li><a href=#updating-a-rule>Updating a Rule</a></li></ul></li></ul></nav></aside></main></body></html>