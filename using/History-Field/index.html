<!DOCTYPE html>
<html lang="en-us" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.18.1" />
    <meta name="description" content="TFS Aggregator Documentation">
<meta name="author" content="TFS Aggregator Team">

    <link rel="shortcut icon" href="https://tfsaggregator.github.io/images/favicon.png" type="image/x-icon" />

    
    <title>History field</title>
    <link href="https://tfsaggregator.github.io//css/nucleus.css" rel="stylesheet">
    <link href="https://tfsaggregator.github.io//css/font-awesome.min.css" rel="stylesheet">
    <link href="https://tfsaggregator.github.io//css/hybrid.css" rel="stylesheet">
    <link href="https://tfsaggregator.github.io//css/featherlight.min.css" rel="stylesheet">
    <link href="https://tfsaggregator.github.io//css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="https://tfsaggregator.github.io//css/horsey.css" rel="stylesheet">
    <link href="https://tfsaggregator.github.io//css/theme.css" rel="stylesheet">
    <link href="https://tfsaggregator.github.io//css/hugo-theme.css" rel="stylesheet">
    <script src="https://tfsaggregator.github.io//js/jquery-2.x.min.js"></script>
    <style type="text/css">:root #header + #content > #left > #rlblock_left
    {display:none !important;}</style>
    

  </head>
  <body class="" data-url="/using/History-Field/">
    <nav id="sidebar">
  <div id="header-wrapper">
    <div id="header">
      <table style="border: none">
  <tr>
<td style="border: none">
<a id="logo" href="https://tfsaggregator.github.io/">
  <svg width="64pt" height="64pt" viewBox="0 0 256 256" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path fill="#67217a" d=" M 0.00 0.00 L 256.00 0.00 L 256.00 256.00 L 0.00 256.00 L 0.00 0.00 Z" />
  <path fill="#ffffff" d=" M 17.06 22.33 C 64.21 22.35 111.36 22.26 158.51 22.37 C 158.55 35.94 158.57 49.51 158.49 63.08 C 132.37 63.47 106.23 63.07 80.10 63.28 C 82.26 66.12 84.60 68.83 87.05 71.42 C 91.26 70.04 94.98 67.51 99.22 66.25 C 101.06 65.50 102.60 67.10 104.05 67.98 C 115.48 76.67 126.96 85.29 138.59 93.70 C 158.53 73.23 178.15 52.46 198.09 32.00 C 214.00 38.19 229.79 44.69 245.68 50.96 C 245.08 96.98 245.80 143.03 245.31 189.05 C 229.48 195.67 213.45 201.86 197.42 208.00 C 182.35 191.95 166.51 176.63 151.13 160.86 C 147.11 156.87 143.34 152.62 139.07 148.88 C 126.48 157.93 114.29 167.53 101.77 176.69 C 97.62 174.24 93.52 171.67 89.09 169.75 C 84.11 175.31 79.28 181.03 75.20 187.28 C 103.49 187.49 131.78 187.24 160.07 187.41 C 160.33 200.92 160.43 214.43 160.32 227.95 C 111.80 228.05 63.27 228.03 14.75 227.96 C 14.67 217.29 14.69 206.62 14.73 195.96 C 14.57 194.50 15.33 193.27 16.22 192.22 C 28.37 177.36 40.40 162.41 52.52 147.54 C 59.10 138.87 66.55 130.88 72.85 122.00 C 68.63 116.03 63.47 110.81 58.78 105.22 C 45.32 89.38 31.70 73.67 18.17 57.89 C 16.64 56.35 17.09 54.03 16.97 52.07 C 17.08 42.16 16.90 32.24 17.06 22.33 Z" />
  <path fill="#67217a" d=" M 24.90 30.93 C 67.15 30.90 109.40 30.76 151.65 31.00 C 151.68 38.75 151.69 46.51 151.65 54.26 C 121.70 54.50 91.74 54.23 61.79 54.39 C 70.37 64.79 79.23 74.97 88.07 85.14 C 93.20 83.35 97.74 80.27 102.78 78.28 C 114.68 87.58 126.41 97.13 138.64 105.98 C 157.56 87.44 175.94 68.33 195.00 49.92 C 206.84 54.51 218.61 59.27 230.37 64.06 C 230.43 101.98 230.50 139.90 230.34 177.82 C 219.78 182.24 209.08 186.30 198.51 190.70 C 196.92 191.24 194.69 192.47 193.43 190.68 C 175.17 172.40 156.94 154.09 138.63 135.88 C 126.38 144.79 114.64 154.38 102.66 163.65 C 97.99 161.68 93.69 158.93 89.00 157.05 C 87.45 157.70 86.56 159.27 85.44 160.45 C 75.66 172.62 65.70 184.64 55.93 196.81 C 88.46 197.08 121.00 196.63 153.53 197.04 C 153.55 204.68 153.55 212.33 153.53 219.98 C 109.78 220.29 66.01 220.15 22.26 220.05 C 22.21 214.68 22.21 209.30 22.20 203.93 C 22.28 202.33 22.04 200.50 23.30 199.28 C 43.25 174.88 63.09 150.38 83.04 125.97 C 83.99 124.77 84.88 123.53 85.77 122.28 C 67.61 100.77 49.17 79.49 30.93 58.04 C 28.97 55.65 26.59 53.53 25.09 50.80 C 24.50 44.20 24.95 37.55 24.90 30.93 Z" />
  <path fill="#ffffff" d=" M 157.63 120.97 C 169.84 111.17 182.27 101.63 194.68 92.07 C 194.73 111.34 194.75 130.61 194.67 149.88 C 182.33 140.23 169.87 130.73 157.63 120.97 Z" />
  <path fill="#ffffff" d=" M 102.11 100.26 C 105.75 102.38 108.43 105.69 111.41 108.59 C 115.46 112.73 119.70 116.68 123.61 120.96 C 119.83 125.06 115.77 128.89 111.86 132.87 C 108.73 135.96 105.82 139.35 102.10 141.77 C 102.76 139.96 103.55 138.19 104.78 136.69 C 109.18 131.18 113.80 125.86 118.09 120.26 C 112.85 113.54 106.10 107.85 102.11 100.26 Z" />
  </svg>
</a>
</td>
    <td style="border: none; text-align: left">
<div style="font-weight: 300">
  TFS Aggregator
</div>
    </td>
</tr>
</table>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input id="search-by" type="text" placeholder="Search">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>
<script type="text/javascript" src="https://tfsaggregator.github.io//js/lunr.min.js"></script>
<script type="text/javascript" src="https://tfsaggregator.github.io//js/horsey.js"></script>
<script type="text/javascript">
    var baseurl = "https:\/\/tfsaggregator.github.io\/";
</script>
<script type="text/javascript" src="https://tfsaggregator.github.io//js/search.js"></script>

    
</div>


  <div class="highlightable">
    <ul class="topics">
      
      
        
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/intro/">
        <a href="https://tfsaggregator.github.io/intro/">
          <span>
            
              <b>1. </b>
            
             Introduction
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/intro/how-it-works/">
              <a href="https://tfsaggregator.github.io/intro/how-it-works/">
                <span>How it Works     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/intro/slack-coc/">
              <a href="https://tfsaggregator.github.io/intro/slack-coc/">
                <span>Code of Conduct     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  parent" data-nav-id="/using/">
        <a href="https://tfsaggregator.github.io/using/">
          <span>
            
              <b>2. </b>
            
             Users&#39; Guide
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/using/writing-rules/">
              <a href="https://tfsaggregator.github.io/using/writing-rules/">
                <span>Writing Rules and Policies     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/policy-syntax/">
              <a href="https://tfsaggregator.github.io/using/policy-syntax/">
                <span>Configuration XML syntax     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/scripting/">
              <a href="https://tfsaggregator.github.io/using/scripting/">
                <span>Scripting the Rules     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/object-model/">
              <a href="https://tfsaggregator.github.io/using/object-model/">
                <span>Objects Reference     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/objects-reference/self-object/">
              <a href="https://tfsaggregator.github.io/using/objects-reference/self-object/">
                <span>self Object     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/objects-reference/store-object/">
              <a href="https://tfsaggregator.github.io/using/objects-reference/store-object/">
                <span>store Object     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/objects-reference/logger-object/">
              <a href="https://tfsaggregator.github.io/using/objects-reference/logger-object/">
                <span>logger Object     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/objects-reference/library-objects/">
              <a href="https://tfsaggregator.github.io/using/objects-reference/library-objects/">
                <span>Library Objects     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/policy-examples/">
              <a href="https://tfsaggregator.github.io/using/policy-examples/">
                <span>Examples of Policies     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/examples/auto-open-auto-close/">
              <a href="https://tfsaggregator.github.io/using/examples/auto-open-auto-close/">
                <span>Auto-Open and Auto-Close     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/examples/auto-create-children/">
              <a href="https://tfsaggregator.github.io/using/examples/auto-create-children/">
                <span>Auto-Create Children     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/scripting-tricks-n-tips/">
              <a href="https://tfsaggregator.github.io/using/scripting-tricks-n-tips/">
                <span>Tricks &amp; Tips     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/scripting-pitfalls/">
              <a href="https://tfsaggregator.github.io/using/scripting-pitfalls/">
                <span>Common Pitfalls     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item active" data-nav-id="/using/History-Field/">
              <a href="https://tfsaggregator.github.io/using/History-Field/">
                <span>History field     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/using/upgrade-from-v1/">
              <a href="https://tfsaggregator.github.io/using/upgrade-from-v1/">
                <span>Upgrading from v1     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/admin/">
        <a href="https://tfsaggregator.github.io/admin/">
          <span>
            
              <b>3. </b>
            
             Administrator Guide
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/admin/install/">
              <a href="https://tfsaggregator.github.io/admin/install/">
                <span>Installing the Server Plugin     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/admin/install-webhooks/">
              <a href="https://tfsaggregator.github.io/admin/install-webhooks/">
                <span>Installing the Web Service     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/admin/console-app/">
              <a href="https://tfsaggregator.github.io/admin/console-app/">
                <span>Using the console to test Policies     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/admin/troubleshooting/">
              <a href="https://tfsaggregator.github.io/admin/troubleshooting/">
                <span>Troubleshooting     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/admin/security/">
              <a href="https://tfsaggregator.github.io/admin/security/">
                <span>Security     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/contrib/">
        <a href="https://tfsaggregator.github.io/contrib/">
          <span>
            
              <b>4. </b>
            
             Contributing
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/contrib/developer-intro/">
              <a href="https://tfsaggregator.github.io/contrib/developer-intro/">
                <span>Introduction to Contributors     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/contrib/source-code/">
              <a href="https://tfsaggregator.github.io/contrib/source-code/">
                <span>Source Code     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/contrib/local-build/">
              <a href="https://tfsaggregator.github.io/contrib/local-build/">
                <span>Local Build     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/contrib/debugging/">
              <a href="https://tfsaggregator.github.io/contrib/debugging/">
                <span>Debugging     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/contrib/continuous-integration/">
              <a href="https://tfsaggregator.github.io/contrib/continuous-integration/">
                <span>Continuous Integration     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
    </ul>
    <hr>
     
     <section id="contacts">
  <div style="padding-left: 1em; ">
    <a href="mailto:tfsaggregator@outlook.com"><i class="fa fa-envelope">&nbsp;</i>tfsaggregator@outlook.com</a>
    <br/>
    <a href="https://twitter.com/tfsaggregator"><i class="fa fa-twitter">&nbsp;</i>@tfsaggregator</a>
    <br/>
    <div style="padding-top: 4pt;">
    <a href="https://slackin-tfsaggregator.herokuapp.com/">
      <img alt="Slack Team Badge" src="https://slackin-tfsaggregator.herokuapp.com/badge.svg" />
    </a>
    </div>
  </div>
</section>
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fa fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>
    </section>
  </div>
</nav>

        <section id="body">
        <div id="overlay"></div>

        <div class="padding highlightable">

            <div id="top-bar">
              
                
                
                
              <div id="top-github-link">
                  <a class="github-link" href="https://github.com/tfsaggregator/tfsaggregator-docs-hugo/edit/master/content/using/History-Field.md" target="blank">
                    <i class="fa fa-code-fork"></i>
                    Edit this page
                  </a>
              </div>
                
              
              <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                  <span id="sidebar-toggle-span">
                      <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                        <i class="fa fa-bars"></i>
                      </a>
                  </span>
                
                <span id="toc-menu"><a href=""><i class="fa fa-list-alt"></i></a></span>
                
                
                
                
                  
                
                  
                
                  
                
                  
                
                  
                    
                    
                <a href="https://tfsaggregator.github.io/using/" itemprop="url"><span itemprop="title">Users&#39; Guide</span></a> <i class="fa fa-angle-right"></i>
                    
                  
                
                <span itemprop="title"> History field</span>
              </div>
              
                  <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#history-field">History field</a>
<ul>
<li><a href="#some-background-information">Some background information</a></li>
<li><a href="#marker-technique">Marker Technique</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

              

            </div>
            
    	        <div id="body-inner">
                
                <h1>History field</h1>
                



<h2 id="history-field">History field</h2>

<p>The History field always appends a new message, the property allows to edit the message until work item is saved.</p>

<p>For example, this code causes an infinite loop (eventually stopped by <strong>rateLimiting</strong> feature).</p>

<pre><code>self.History = &quot;Hello&quot;;
</code></pre>

<p>Aggregator is triggered again and again for the same work item.</p>

<h3 id="some-background-information">Some background information</h3>

<p>The TFS aggregator only updates a work item if any field has changed by its calculations. If the calculations yield the same value as last time, the work item is considered clean and no new revision is created.</p>

<p>The History field is a strange kind of field, it always being empty, unless you&rsquo;ve added a new value to it while processing. Therefore, setting the history field to anything other than <code>string.Empty</code> or <code>null</code> will cause a workitem to be saved.</p>

<p>Whenever a workitem is saved, the TFS Aggregator triggers again. This is by design and allows for cascading rules. It&rsquo;s also why we&rsquo;ve recently added a rate limiter. Normally the same set of rules triggers again, all calculations yield the same value and that breaks the loop that would otherwise be created.</p>

<p><em>Except</em> when a rule always sets the value of the history field. As it was <strong>empty</strong> when we started calculating and is now <strong>not empty</strong> it will cause the work item to be saved.</p>

<p>To prevent this from happening there are a few things you can do:</p>

<ol>
<li>Before setting the History field, check the <code>.IsDirty</code> property of the work item. If it&rsquo;s not dirty, don&rsquo;t add anything to the history.</li>
<li>Iterate through the revisions of the work item to ensure that you&rsquo;re not adding the same comment you added last time. This causes additional database and network traffic, and is therefore less desirable.</li>
<li>Don&rsquo;t store your data in the History Field, instead stick it in a custom field or use any of the pre-existing fields to store your data in. (Don&rsquo;t append to an existing field as that would cause the same behavior)</li>
<li>If you&rsquo;re not using Impersonation, check whether the &ldquo;<em>Changed By</em>&rdquo; field is set to the service account and assume that the changes are not made by a human, therefore skipping the changes to the history field.</li>
</ol>

<h3 id="marker-technique">Marker Technique</h3>

<p>This technique corresponds to suggestion #2, i.e. using a Marker to distinguish between user and rule changes.</p>

<pre><code>const string HistoryMarker = &quot;===&quot;;

var lastRevision = self.LastRevision;
var history = lastRevision.Fields[&quot;History&quot;];
string lastValue = (string) history.Value;

logger.Log(&quot;At revision {0} History value is '{1}'&quot;, lastRevision.Index, lastValue);

if (!lastValue.StartsWith(HistoryMarker))
{
  self.History = HistoryMarker + &quot;Hello&quot;;
  logger.Log(&quot;Marker added&quot;);
}
</code></pre>


      
      </div>
          <div class="row">
          <div class="footer-panel">
<p>Last revision: January 5, 2017 | <a href="https://github.com/tfsaggregator/tfsaggregator-docs-hugo/commit/134c142ebc4c7804ac10ac2a833b2eced77fa13c">Initial commit (134c142)</a>
            <span style="float: right;">TFS Aggregator Documentation v2.3</span>
          </p>
          </div>
      </div>
    </div>

    <div id="navigation">
        
        <a class="nav nav-prev" href="https://tfsaggregator.github.io//using/scripting-pitfalls"> <i class="fa fa-chevron-left"></i></a>
        <a class="nav nav-next" href="https://tfsaggregator.github.io//using/upgrade-from-v1" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://tfsaggregator.github.io//js/clipboard.min.js"></script>
    <script src="https://tfsaggregator.github.io//js/perfect-scrollbar.min.js"></script>
    <script src="https://tfsaggregator.github.io//js/perfect-scrollbar.jquery.min.js"></script>
    <script src="https://tfsaggregator.github.io//js/jquery.sticky-kit.min.js"></script>
    <script src="https://tfsaggregator.github.io//js/featherlight.min.js"></script>
    <script src="https://tfsaggregator.github.io//js/html5shiv-printshiv.min.js"></script>
    <script src="https://tfsaggregator.github.io//js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://tfsaggregator.github.io//js/modernizr.custom.71422.js"></script>
    <script src="https://tfsaggregator.github.io//js/learn.js"></script>
    <script src="https://tfsaggregator.github.io//js/hugo-learn.js"></script>
    

  </body>
</html>

